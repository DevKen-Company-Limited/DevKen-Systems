<div class="absolute inset-0 flex min-w-0 flex-col overflow-y-auto" cdkScrollable>

  <!-- ── Reusable Page Header ────────────────────────────────────────────── -->
  <app-page-header
    title="Classes Management"
    description="Manage class information, capacity, and assignments"
    icon="school"
    [breadcrumbs]="breadcrumbs"
    [actionTemplate]="headerActions">
  </app-page-header>

  <!-- Header Actions Template -->
  <ng-template #headerActions>
    <button mat-flat-button 
      class="bg-white text-indigo-700 hover:bg-yellow-200 hover:text-indigo-900 shadow-lg transition-all hover:shadow-xl font-bold" 
      (click)="openCreate()">
      <mat-icon class="icon-size-5">add</mat-icon>
      <span class="ml-2">Add</span>
    </button>
  </ng-template>

  <!-- ── Main Content ───────────────────────────────────────────────────── -->
  <div class="bg-card -mt-10 flex-auto rounded-t-2xl p-6 shadow sm:p-10">

    <!-- Stats Cards (Reusable Component) -->
    <app-stats-cards [cards]="statsCards" [columns]="4"></app-stats-cards>

    <!-- Filter Panel Section -->
    <div class="mb-6">
      <app-filter-panel
        [fields]="filterFields"
        [showPanel]="showFilterPanel"
        [columns]="4"
        (filterChange)="onFilterChange($event)"
        (clearAll)="onClearFilters()"
        (togglePanel)="toggleFilterPanel()">
      </app-filter-panel>
    </div>

    <!-- ── Reusable Data Table ───────────────────────────────────────────── -->
    <app-data-table
      [columns]="tableColumns"
      [data]="paginatedData"
      [actions]="tableActions"
      [loading]="isLoading"
      [header]="tableHeader"
      [emptyState]="tableEmptyState"
      [cellTemplates]="cellTemplates">
    </app-data-table>

    <!-- Pagination (Reusable Component) -->
    <app-pagination
      *ngIf="!isLoading"
      [currentPage]="currentPage"
      [totalItems]="filteredData.length"
      [itemsPerPage]="itemsPerPage"
      [itemLabel]="'classes'"
      [showItemsPerPageSelector]="true"
      [showPageNumbers]="true"
      (pageChange)="onPageChange($event)"
      (itemsPerPageChange)="onItemsPerPageChange($event)">
    </app-pagination>
  </div>
</div>

<!-- ══════════════════════════════════════════════════════════════════════ -->
<!-- Cell Templates for Data Table -->
<!-- ══════════════════════════════════════════════════════════════════════ -->

<!-- Class Cell Template -->
<ng-template #classCell let-row>
  <div class="flex items-center gap-3">
    <div 
      class="w-10 h-10 rounded-lg flex items-center justify-center shadow-sm"
      [class.bg-gradient-to-br]="row.isActive"
      [class.from-indigo-400]="row.isActive"
      [class.to-indigo-600]="row.isActive"
      [class.bg-gray-400]="!row.isActive">
      <mat-icon class="text-white icon-size-5">school</mat-icon>
    </div>
    <div>
      <div class="font-semibold text-gray-900 dark:text-white flex items-center gap-2">
        {{ row.name }}
        <mat-icon *ngIf="row.isFull" class="text-amber-500 icon-size-4" matTooltip="Class is full">warning</mat-icon>
      </div>
      <div class="text-sm text-gray-500 dark:text-gray-400">
        {{ row.code }}
      </div>
    </div>
  </div>
</ng-template>

<!-- School Cell Template (SuperAdmin only) -->
<ng-template #schoolCell let-row>
  <div class="flex items-center gap-2">
    <mat-icon class="icon-size-4 text-gray-500">business</mat-icon>
    <div>
      <div class="text-sm font-medium text-gray-900 dark:text-white">
        {{ getSchoolName(row.schoolId) }}
      </div>
      <div class="text-xs text-gray-500 dark:text-gray-400">
        {{ getSchoolSlug(row.schoolId) }}
      </div>
    </div>
  </div>
</ng-template>

<!-- Level Cell Template -->
<ng-template #levelCell let-row>
  <span class="inline-flex items-center px-3 py-1 text-xs font-semibold rounded-full bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400">
    {{ row.levelName }}
  </span>
</ng-template>

<!-- Capacity Cell Template -->
<ng-template #capacityCell let-row>
  <div class="flex flex-col gap-1 min-w-[140px]">
    <div class="flex items-center gap-2 text-sm">
      <mat-icon class="icon-size-4 text-gray-500">groups</mat-icon>
      <span class="font-semibold text-gray-900 dark:text-white">{{ row.currentEnrollment }} / {{ row.capacity }}</span>
      <span class="text-xs text-gray-500">({{ getCapacityUtilization(row) }}%)</span>
    </div>
    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-1.5">
      <div 
        class="h-1.5 rounded-full transition-all"
        [style.width.%]="getCapacityUtilization(row)"
        [ngClass]="{
          'bg-green-500': getCapacityUtilization(row) < 70,
          'bg-amber-500': getCapacityUtilization(row) >= 70 && getCapacityUtilization(row) < 90,
          'bg-red-500': getCapacityUtilization(row) >= 90
        }">
      </div>
    </div>
    <span class="text-xs text-gray-500">
      {{ row.availableSeats }} seats available
    </span>
  </div>
</ng-template>

<!-- Teacher Cell Template -->
<ng-template #teacherCell let-row>
  <div *ngIf="row.teacherName" class="flex items-center gap-2 text-sm text-gray-900 dark:text-white">
    <mat-icon class="icon-size-4 text-gray-500">person</mat-icon>
    <span>{{ row.teacherName }}</span>
  </div>
  <span *ngIf="!row.teacherName" class="text-sm text-gray-400 italic">
    No teacher assigned
  </span>
</ng-template>

<!-- Academic Year Cell Template -->
<ng-template #academicYearCell let-row>
  <div class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
    <mat-icon class="icon-size-4 text-gray-500">calendar_today</mat-icon>
    <span>{{ row.academicYearName }}</span>
  </div>
</ng-template>

<!-- Status Cell Template -->
<ng-template #statusCell let-row>
  <span 
    class="px-3 py-1 rounded-full text-xs font-semibold"
    [ngClass]="{
      'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400': row.isActive,
      'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400': !row.isActive
    }">
    {{ row.isActive ? 'Active' : 'Inactive' }}
  </span>
</ng-template>