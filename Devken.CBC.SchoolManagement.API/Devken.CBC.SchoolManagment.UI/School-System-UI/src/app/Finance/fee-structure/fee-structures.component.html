<div class="absolute inset-0 flex min-w-0 flex-col overflow-y-auto" cdkScrollable>

  <!-- ── Page Header ─────────────────────────────────────────────────────── -->
  <app-page-header
    title="Fee Structures"
    description="Define fee amounts per academic year, term, CBC level, and student category"
    icon="account_balance"
    [breadcrumbs]="breadcrumbs"
    [actionTemplate]="headerActions">
  </app-page-header>

  <!-- Header Action Template -->
  <ng-template #headerActions>
    <button mat-flat-button
      class="bg-white text-emerald-700 hover:bg-emerald-50 hover:text-emerald-900 shadow-lg transition-all hover:shadow-xl font-bold"
      (click)="openCreate()">
      <mat-icon class="icon-size-5">add</mat-icon>
      <span class="ml-2">Add</span>
    </button>
  </ng-template>

  <!-- ── Body ────────────────────────────────────────────────────────────── -->
  <div class="flex flex-col flex-auto p-4 sm:p-6 gap-4 overflow-y-auto bg-gray-50 dark:bg-gray-900">

    <!-- Stats -->
    <app-stats-cards [cards]="statsCards" [columns]="4"></app-stats-cards>

    <!-- Filter Panel -->
    <app-filter-panel
      [fields]="filterFields"
      [showPanel]="showFilters"
      [columns]="4"
      (filterChange)="onFilterChange($event)"
      (clearAll)="onClearFilters()"
      (togglePanel)="showFilters = !showFilters">
    </app-filter-panel>

    <!-- Data Table -->
    <app-data-table
      [columns]="tableColumns"
      [data]="paginatedData"
      [actions]="tableActions"
      [loading]="isLoading"
      [header]="tableHeader"
      [emptyState]="emptyState"
      [cellTemplates]="cellTemplates"
      (rowClick)="onRowClick($event)"
      (columnHeaderClick)="onColumnHeaderClick($event)">

      <!-- ── Fee Item cell: name + academic year line ──────────────────────── -->
      <ng-template #feeItemCell let-row>
        <div class="flex flex-col">
          <span class="text-sm font-semibold text-gray-900 dark:text-white">{{ row.feeItemName }}</span>
        </div>
      </ng-template>

      <!-- ── Year / Term cell ─────────────────────────────────────────────── -->
      <ng-template #yearTermCell let-row>
        <div class="flex flex-col">
          <span class="text-sm font-medium text-gray-800 dark:text-gray-200">{{ row.academicYearName }}</span>
          <span *ngIf="row.termName; else annualTag" class="text-xs text-teal-600 dark:text-teal-400 font-medium">
            {{ row.termName }}
          </span>
          <ng-template #annualTag>
            <span class="text-xs text-gray-400 italic">Annual</span>
          </ng-template>
        </div>
      </ng-template>

      <!-- ── CBC Level cell ───────────────────────────────────────────────── -->
      <ng-template #levelCell let-row>
        <span *ngIf="row.level !== null && row.level !== undefined; else allLevels"
              class="px-2.5 py-1 text-xs font-semibold rounded-full bg-indigo-50 text-indigo-700
                     dark:bg-indigo-900/30 dark:text-indigo-300">
          {{ resolveLevel(row.level) }}
        </span>
        <ng-template #allLevels>
          <span class="px-2.5 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-500
                       dark:bg-gray-700 dark:text-gray-400">
            All Levels
          </span>
        </ng-template>
      </ng-template>

      <!-- ── Applicable To cell ───────────────────────────────────────────── -->
      <ng-template #applicableCell let-row>
        <span class="px-2.5 py-1 text-xs font-semibold rounded-full"
              [class.bg-blue-50]="row.applicableTo === 0"  [class.text-blue-700]="row.applicableTo === 0"
              [class.bg-sky-50]="row.applicableTo === 1"   [class.text-sky-700]="row.applicableTo === 1"
              [class.bg-violet-50]="row.applicableTo === 2" [class.text-violet-700]="row.applicableTo === 2"
              [class.bg-rose-50]="row.applicableTo === 3"  [class.text-rose-700]="row.applicableTo === 3">
          {{ resolveApplicable(row.applicableTo) }}
        </span>
      </ng-template>

      <!-- ── Amount cell ──────────────────────────────────────────────────── -->
      <ng-template #amountCell let-row>
        <span class="text-sm font-bold text-gray-900 dark:text-white font-mono">
          KES {{ row.amount | number:'1.2-2' }}
        </span>
      </ng-template>

      <!-- ── Max Discount cell ────────────────────────────────────────────── -->
      <ng-template #discountCell let-row>
        <span *ngIf="row.maxDiscountPercent != null; else noDiscount"
              class="px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-50 text-amber-700
                     dark:bg-amber-900/20 dark:text-amber-400">
          {{ row.maxDiscountPercent }}%
        </span>
        <ng-template #noDiscount>
          <span class="text-xs text-gray-400">—</span>
        </ng-template>
      </ng-template>

      <!-- ── Status cell (clickable toggle) ──────────────────────────────── -->
      <ng-template #statusCell let-row>
        <button class="px-3 py-1 rounded-full text-xs font-semibold transition-colors cursor-pointer border-0"
                [class.bg-green-100]="row.isActive"  [class.text-green-700]="row.isActive"
                [class.bg-red-100]="!row.isActive"   [class.text-red-600]="!row.isActive"
                (click)="$event.stopPropagation(); toggleActive(row)">
          {{ row.isActive ? 'Active' : 'Inactive' }}
        </button>
      </ng-template>

    </app-data-table>

    <!-- Pagination -->
    <app-pagination
      *ngIf="filteredData.length > 0"
      [currentPage]="currentPage"
      [totalItems]="filteredData.length"
      [itemsPerPage]="itemsPerPage"
      [showItemsPerPageSelector]="true"
      [itemsPerPageOptions]="[10, 25, 50]"
      [showPageNumbers]="true"
      itemLabel="fee structures"
      (pageChange)="onPageChange($event)"
      (itemsPerPageChange)="onItemsPerPageChange($event)">
    </app-pagination>

  </div>
</div>