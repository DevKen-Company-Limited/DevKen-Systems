<div class="flex flex-col flex-auto min-w-0">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row flex-0 sm:items-center sm:justify-between p-6 sm:py-8 sm:px-10 border-b bg-card dark:bg-gray-900 shadow-sm">
    <div class="flex-1 min-w-0">
      <!-- Breadcrumbs -->
      <div class="flex flex-wrap items-center text-sm font-medium text-gray-500 dark:text-gray-400">
        <a class="hover:text-primary-500 transition-colors">Administration</a>
        <mat-icon class="icon-size-5 mx-1" [svgIcon]="'heroicons_solid:chevron-right'"></mat-icon>
        <a class="hover:text-primary-500 transition-colors">User Management</a>
        <mat-icon class="icon-size-5 mx-1" [svgIcon]="'heroicons_solid:chevron-right'"></mat-icon>
        <span class="text-gray-400">All Users</span>
      </div>

      <!-- Title -->
      <h2 class="mt-2 text-3xl md:text-4xl font-extrabold tracking-tight truncate text-gray-900 dark:text-white">
        User Management
      </h2>
      <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
        Manage system users, roles, and permissions
      </p>
    </div>

    <!-- Actions -->
    <div class="flex shrink-0 items-center mt-6 sm:mt-0 sm:ml-4 gap-3">
      <!-- Stats -->
      <div class="hidden sm:flex items-center gap-4 mr-4">
        <div class="text-center">
          <div class="text-2xl font-bold text-primary">{{ stats.totalUsers }}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">Total Users</div>
        </div>
        <div class="h-10 w-px bg-gray-300 dark:bg-gray-600"></div>
        <div class="text-center">
          <div class="text-2xl font-bold text-green-600">{{ stats.activeUsers }}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">Active</div>
        </div>
      </div>

      <button mat-flat-button color="primary" (click)="loadAll()" [disabled]="isLoading" class="flex items-center gap-2">
        <mat-icon [svgIcon]="'heroicons_outline:arrow-path'"></mat-icon>
        Refresh
      </button>
    </div>
  </div>

  <!-- Alert -->
  <fuse-alert
    class="m-6"
    *ngIf="showAlert"
    [appearance]="'outline'"
    [showIcon]="true"
    [type]="alert.type"
    [dismissible]="true"
    (dismissed)="showAlert = false">
    {{ alert.message }}
  </fuse-alert>

  <!-- Main Content -->
  <div class="flex-auto p-6 sm:p-10">
    <mat-card class="shadow-md hover:shadow-lg transition-shadow">
      <mat-card-header class="pb-4">
        <mat-card-title class="text-2xl font-semibold">All Users</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <!-- Search and Filter -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
          <mat-form-field class="flex-auto">
            <mat-label>Search users</mat-label>
            <input
              matInput
              [(ngModel)]="filterValue"
              (input)="applyFilter($any($event.target).value)"
              placeholder="Name, email, or phone"
              autocomplete="off">
            <mat-icon matPrefix [svgIcon]="'heroicons_outline:magnifying-glass'"></mat-icon>
            <button *ngIf="filterValue" mat-icon-button matSuffix (click)="clearFilter()">
              <mat-icon [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
            </button>
          </mat-form-field>

          <mat-form-field class="md:w-48">
            <mat-label>Filter by status</mat-label>
            <mat-select [(value)]="statusFilter" (selectionChange)="applyStatusFilter()">
              <mat-option [value]="'all'">All Users</mat-option>
              <mat-option [value]="'active'">Active Only</mat-option>
              <mat-option [value]="'inactive'">Inactive Only</mat-option>
            </mat-select>
            <mat-icon matPrefix [svgIcon]="'heroicons_outline:funnel'"></mat-icon>
          </mat-form-field>

          <button 
            mat-flat-button 
            color="primary" 
            (click)="openCreate()"
            class="flex items-center gap-2 md:w-auto w-full">
            <mat-icon [svgIcon]="'heroicons_outline:plus'"></mat-icon>
            <span>New User</span>
          </button>
        </div>

        <!-- Loading Spinner -->
        <div *ngIf="isLoading" class="flex items-center justify-center h-64">
          <mat-spinner [diameter]="48"></mat-spinner>
        </div>

        <!-- Users Table -->
        <div *ngIf="!isLoading" class="overflow-x-auto rounded-md border border-gray-200 dark:border-gray-700">
          <table mat-table [dataSource]="dataSource" matSort class="w-full text-left">
            
            <!-- User Column -->
            <ng-container matColumnDef="user">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold px-4 py-3 bg-gray-50 dark:bg-gray-800">User</th>
              <td mat-cell *matCellDef="let user" class="px-4 py-3">
                <div class="flex items-center gap-3">
                  <div 
                    class="w-10 h-10 rounded-full flex items-center justify-center shadow-sm text-white font-semibold text-sm"
                    [class.bg-gradient-to-br]="user.isActive"
                    [class.from-primary-400]="user.isActive"
                    [class.to-primary-600]="user.isActive"
                    [class.bg-gray-400]="!user.isActive">
                    {{ getInitials(user) }}
                  </div>
                  <div class="truncate">
                    <div class="font-medium text-gray-900 dark:text-white">
                      {{ user.firstName }} {{ user.lastName }}
                    </div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                      ID: {{ user.id.substring(0, 8) }}...
                    </div>
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Email Column -->
            <ng-container matColumnDef="email">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold px-4 py-3 bg-gray-50 dark:bg-gray-800">Email</th>
              <td mat-cell *matCellDef="let user" class="px-4 py-3">
                <div class="flex items-center gap-2">
                  <mat-icon class="icon-size-4 text-gray-400" [svgIcon]="'heroicons_outline:envelope'"></mat-icon>
                  <span class="truncate">{{ user.email }}</span>
                  <mat-icon 
                    *ngIf="user.isEmailVerified" 
                    class="icon-size-5 text-green-500"
                    [svgIcon]="'heroicons_outline:check-badge'"
                    matTooltip="Email verified">
                  </mat-icon>
                  <mat-icon 
                    *ngIf="!user.isEmailVerified" 
                    class="icon-size-5 text-amber-500"
                    [svgIcon]="'heroicons_outline:exclamation-circle'"
                    matTooltip="Email not verified">
                  </mat-icon>
                </div>
              </td>
            </ng-container>

            <!-- School Column (SuperAdmin only) -->
            <ng-container matColumnDef="school">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold px-4 py-3 bg-gray-50 dark:bg-gray-800">School</th>
              <td mat-cell *matCellDef="let user" class="px-4 py-3">
                <div class="flex items-center gap-2">
                  <mat-icon class="icon-size-4 text-gray-400" [svgIcon]="'heroicons_outline:academic-cap'"></mat-icon>
                  <span class="truncate">{{ user.schoolName || 'Not Assigned' }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Phone Column -->
            <ng-container matColumnDef="phone">
              <th mat-header-cell *matHeaderCellDef class="font-semibold px-4 py-3 bg-gray-50 dark:bg-gray-800">Phone</th>
              <td mat-cell *matCellDef="let user" class="px-4 py-3">
                <div class="flex items-center gap-2">
                  <mat-icon class="icon-size-4 text-gray-400" [svgIcon]="'heroicons_outline:phone'"></mat-icon>
                  <span>{{ user.phoneNumber || 'â€”' }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Roles Column -->
            <ng-container matColumnDef="roles">
              <th mat-header-cell *matHeaderCellDef class="font-semibold px-4 py-3 bg-gray-50 dark:bg-gray-800">Assigned Roles</th>
              <td mat-cell *matCellDef="let user" class="px-4 py-3">
                <div class="flex flex-wrap gap-2">
                  <!-- Handle roles array (objects with name property) -->
                  <ng-container *ngIf="user.roles && user.roles.length > 0">
                    <span 
                      *ngFor="let role of user.roles.slice(0, 2)" 
                      class="inline-flex items-center px-2.5 py-0.5 text-xs font-medium rounded-full bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-200">
                      <mat-icon class="icon-size-3 mr-1" [svgIcon]="'heroicons_outline:shield-check'"></mat-icon>
                      {{ role.name }}
                    </span>
                    <span 
                      *ngIf="user.roles.length > 2" 
                      class="inline-flex items-center px-2.5 py-0.5 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 cursor-help"
                      [matTooltip]="getExtraRolesTooltip(user)"
                      matTooltipPosition="above">
                      +{{ user.roles.length - 2 }} more
                    </span>
                  </ng-container>

                  <!-- Handle roleNames array (simple string array) -->
                  <ng-container *ngIf="(!user.roles || user.roles.length === 0) && user.roleNames && user.roleNames.length > 0">
                    <span 
                      *ngFor="let roleName of user.roleNames.slice(0, 2)" 
                      class="inline-flex items-center px-2.5 py-0.5 text-xs font-medium rounded-full bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-200">
                      <mat-icon class="icon-size-3 mr-1" [svgIcon]="'heroicons_outline:shield-check'"></mat-icon>
                      {{ roleName }}
                    </span>
                    <span 
                      *ngIf="user.roleNames.length > 2" 
                      class="inline-flex items-center px-2.5 py-0.5 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 cursor-help"
                      [matTooltip]="getExtraRoleNamesTooltip(user)"
                      matTooltipPosition="above">
                      +{{ user.roleNames.length - 2 }} more
                    </span>
                  </ng-container>

                  <!-- No roles assigned -->
                  <span *ngIf="(!user.roles || user.roles.length === 0) && (!user.roleNames || user.roleNames.length === 0)" class="text-sm text-gray-400 italic">
                    No roles assigned
                  </span>
                </div>
              </td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold px-4 py-3 bg-gray-50 dark:bg-gray-800">Status</th>
              <td mat-cell *matCellDef="let user" class="px-4 py-3">
                <span 
                  class="inline-flex items-center px-3 py-1 text-xs font-medium rounded-full"
                  [class.bg-green-100]="user.isActive"
                  [class.dark:bg-green-900]="user.isActive"
                  [class.text-green-800]="user.isActive"
                  [class.dark:text-green-200]="user.isActive"
                  [class.bg-red-100]="!user.isActive"
                  [class.dark:bg-red-900]="!user.isActive"
                  [class.text-red-800]="!user.isActive"
                  [class.dark:text-red-200]="!user.isActive">
                  <span 
                    class="w-2 h-2 rounded-full mr-2"
                    [class.bg-green-600]="user.isActive"
                    [class.dark:bg-green-400]="user.isActive"
                    [class.bg-red-600]="!user.isActive"
                    [class.dark:bg-red-400]="!user.isActive">
                  </span>
                  {{ user.isActive ? 'Active' : 'Inactive' }}
                </span>
              </td>
            </ng-container>

            <!-- Last Login Column -->
            <ng-container matColumnDef="lastLogin">
              <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold px-4 py-3 bg-gray-50 dark:bg-gray-800">Last Updated</th>
              <td mat-cell *matCellDef="let user" class="px-4 py-3">
                <div class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
                  <mat-icon class="icon-size-4" [svgIcon]="'heroicons_outline:clock'"></mat-icon>
                  <span>{{ formatDate(user.updatedOn) }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef class="font-semibold px-4 py-3 text-right bg-gray-50 dark:bg-gray-800">Actions</th>
              <td mat-cell *matCellDef="let user" class="px-4 py-3 text-right">
                <button mat-icon-button [matMenuTriggerFor]="menu" matTooltip="More actions">
                  <mat-icon [svgIcon]="'heroicons_outline:ellipsis-vertical'"></mat-icon>
                </button>
                
                <mat-menu #menu="matMenu">
                  <button mat-menu-item (click)="openEdit(user)">
                    <mat-icon [svgIcon]="'heroicons_outline:pencil'"></mat-icon>
                    <span>Edit User</span>
                  </button>
                  
                  <button mat-menu-item (click)="toggleUserStatus(user)">
                    <mat-icon [svgIcon]="user.isActive ? 'heroicons_outline:no-symbol' : 'heroicons_outline:check-circle'"></mat-icon>
                    <span>{{ user.isActive ? 'Deactivate' : 'Activate' }}</span>
                  </button>
                  
                  <button mat-menu-item (click)="resetPassword(user)">
                    <mat-icon [svgIcon]="'heroicons_outline:lock-closed'"></mat-icon>
                    <span>Reset Password</span>
                  </button>
                  
                  <button 
                    mat-menu-item 
                    (click)="resendWelcomeEmail(user)"
                    *ngIf="!user.isEmailVerified">
                    <mat-icon [svgIcon]="'heroicons_outline:envelope'"></mat-icon>
                    <span>Resend Welcome Email</span>
                  </button>
                  
                  <mat-divider></mat-divider>
                  
                  <button 
                    mat-menu-item 
                    (click)="removeUser(user)" 
                    class="text-warn">
                    <mat-icon [svgIcon]="'heroicons_outline:trash'"></mat-icon>
                    <span>Delete User</span>
                  </button>
                </mat-menu>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns" class="bg-gray-50 dark:bg-gray-800"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors"></tr>
          </table>

          <!-- Empty State -->
          <div *ngIf="dataSource.data.length === 0" class="text-center py-16">
            <mat-icon class="icon-size-16 mb-4 text-gray-400" [svgIcon]="'heroicons_outline:user-group'"></mat-icon>
            <h3 class="text-xl font-semibold mb-2 text-gray-900 dark:text-white">No Users Found</h3>
            <p class="text-gray-500 dark:text-gray-400 mb-4">
              {{ filterValue ? 'Try adjusting your search' : 'Get started by creating your first user' }}
            </p>
            <button 
              *ngIf="!filterValue" 
              mat-flat-button 
              color="primary" 
              (click)="openCreate()"
              class="flex items-center gap-2 mx-auto">
              <mat-icon [svgIcon]="'heroicons_outline:plus'"></mat-icon>
              Create User
            </button>
          </div>

          <!-- Paginator -->
          <mat-paginator 
            *ngIf="dataSource.data.length > 0"
            [length]="total || dataSource.data.length" 
            [pageSize]="pageSize" 
            [pageSizeOptions]="[10, 20, 50, 100]" 
            (page)="onPageChange($event)"
            class="border-t">
          </mat-paginator>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>