<div class="flex flex-col h-full w-full">

  <!-- Page Header -->
  <app-page-header
    title="Parents & Guardians"
    description="Manage all parents and guardians linked to students"
    icon="family_restroom"
    [breadcrumbs]="breadcrumbs"
    [actionTemplate]="headerActions">
  </app-page-header>

  <!-- Header Actions -->
  <ng-template #headerActions>
    <button mat-flat-button color="primary"
            class="bg-white text-indigo-700 font-semibold shadow hover:bg-indigo-50"
            (click)="openCreate()">
      <mat-icon class="icon-size-5">add</mat-icon>
      <span class="ml-1">Add Parent</span>
    </button>
  </ng-template>

  <!-- Content -->
  <div class="p-6 flex flex-col gap-6">

    <!-- Stats -->
    <app-stats-cards [cards]="statsCards" [columns]="4"></app-stats-cards>

    <!-- Filters -->
    <app-filter-panel
      [fields]="filterFields"
      [showPanel]="showFilters"
      [columns]="4"
      (filterChange)="onFilterChange($event)"
      (clearAll)="onClearFilters()"
      (togglePanel)="showFilters = !showFilters">
    </app-filter-panel>

    <!-- Table -->
    <app-data-table
      [columns]="columns"
      [data]="paginatedData"
      [actions]="actions"
      [loading]="isLoading"
      [header]="tableHeader"
      [emptyState]="emptyState"
      [cellTemplates]="cellTemplates"
      [hoverEffect]="true">
    </app-data-table>

    <!-- Pagination -->
    <app-pagination
      [currentPage]="currentPage"
      [totalItems]="filteredData.length"
      [itemsPerPage]="itemsPerPage"
      [showItemsPerPageSelector]="true"
      [showPageNumbers]="true"
      itemLabel="parents"
      (pageChange)="onPageChange($event)"
      (itemsPerPageChange)="onItemsPerPageChange($event)">
    </app-pagination>
  </div>
</div>

<!-- ── Cell Templates ──────────────────────────────────────────────────── -->

<!-- Status -->
<ng-template #statusTpl let-row>
  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold"
        [ngClass]="row.status === 'Active'
          ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'
          : 'bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400'">
    {{ row.status }}
  </span>
</ng-template>

<!-- Flags/Badges -->
<ng-template #badgesTpl let-row>
  <div class="flex items-center justify-center gap-1 flex-wrap">
    <span *ngIf="row.isPrimaryContact"
          class="inline-flex items-center gap-0.5 px-1.5 py-0.5 text-xs font-medium rounded bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400">
      <mat-icon class="icon-size-3">star</mat-icon> Primary
    </span>
    <span *ngIf="row.isEmergencyContact"
          class="inline-flex items-center gap-0.5 px-1.5 py-0.5 text-xs font-medium rounded bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400">
      <mat-icon class="icon-size-3">emergency</mat-icon> Emergency
    </span>
    <span *ngIf="row.hasPortalAccess"
          class="inline-flex items-center gap-0.5 px-1.5 py-0.5 text-xs font-medium rounded bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400">
      <mat-icon class="icon-size-3">manage_accounts</mat-icon> Portal
    </span>
  </div>
</ng-template>

<!-- Relationship -->
<ng-template #relationshipTpl let-row>
  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-violet-100 text-violet-700 dark:bg-violet-900/30 dark:text-violet-400">
    {{ row.relationshipDisplay }}
  </span>
</ng-template>