<!-- grade-review-step/grade-review-step.component.html -->
<div class="max-w-6xl">

  <!-- Section Header -->
  <div class="flex items-start gap-4 mb-8">
    <div class="flex items-center justify-center w-14 h-14 rounded-xl
                bg-gradient-to-br from-green-500 to-emerald-600 shadow-lg">
      <mat-icon class="text-white !w-7 !h-7">check_circle</mat-icon>
    </div>
    <div class="flex-1">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-1">Review & Submit</h2>
      <p class="text-gray-600 dark:text-gray-400">
        Review all grade information before submitting. Click any section to edit.
      </p>
    </div>
  </div>

  <!-- Progress Bar -->
  <div class="mb-6">
    <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden mb-2">
      <div class="h-full bg-gradient-to-r from-green-500 to-emerald-600 transition-all duration-500"
           [style.width.%]="getCompletionPct()"></div>
    </div>
    <p class="text-sm text-gray-600 dark:text-gray-400">
      {{ completedCount() }} of {{ steps.length - 1 }} sections completed
    </p>
  </div>

  <!-- Incomplete Warning -->
  <fuse-alert *ngIf="!allComplete()" type="warning" appearance="soft" [showIcon]="true" class="mb-6">
    Some sections are incomplete. Please go back and fill in all required fields before submitting.
  </fuse-alert>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- ── Student & Subject Card ─────────────────────────────── -->
    <mat-card class="shadow-md hover:shadow-lg transition-shadow cursor-pointer"
              (click)="editSection.emit(0)">
      <mat-card-header class="!pb-2">
        <div class="flex items-center justify-between w-full">
          <div class="flex items-center gap-3">
            <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-indigo-100 dark:bg-indigo-900/20">
              <mat-icon class="text-indigo-600">person</mat-icon>
            </div>
            <mat-card-title class="!text-base !font-semibold !mb-0">Student & Subject</mat-card-title>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs font-medium px-2 py-1 rounded" [ngClass]="{
              'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300': isComplete(0),
              'bg-gray-100  text-gray-600  dark:bg-gray-700      dark:text-gray-400': !isComplete(0)
            }">{{ isComplete(0) ? '✓ Complete' : 'Incomplete' }}</span>
            <mat-icon class="text-gray-400 icon-size-4">edit</mat-icon>
          </div>
        </div>
      </mat-card-header>
      <mat-card-content class="!pt-4">
        <div class="space-y-3">

          <!-- Student -->
          <div class="flex items-center gap-3 p-3 rounded-lg
                      bg-indigo-50 dark:bg-indigo-900/10">
            <div class="flex items-center justify-center w-8 h-8 rounded-full
                        bg-indigo-100 dark:bg-indigo-900/30 flex-shrink-0">
              <mat-icon class="text-indigo-600 icon-size-4">person</mat-icon>
            </div>
            <div class="min-w-0 flex-1">
              <p class="text-xs text-gray-500 dark:text-gray-400">Student</p>
              <p class="text-sm font-semibold text-gray-900 dark:text-white truncate">{{ studentDisplay }}</p>
              <p *ngIf="studentAdmNo" class="text-xs text-gray-400">Adm: {{ studentAdmNo }}</p>
            </div>
          </div>

          <!-- Subject -->
          <div class="flex items-center gap-3 p-3 rounded-lg
                      bg-violet-50 dark:bg-violet-900/10">
            <div class="flex items-center justify-center w-8 h-8 rounded-full
                        bg-violet-100 dark:bg-violet-900/30 flex-shrink-0">
              <mat-icon class="text-violet-600 icon-size-4">menu_book</mat-icon>
            </div>
            <div class="min-w-0 flex-1">
              <p class="text-xs text-gray-500 dark:text-gray-400">Subject</p>
              <p class="text-sm font-semibold text-gray-900 dark:text-white truncate">
                {{ subjectDisplay }}
                <span *ngIf="subjectCode" class="text-xs font-normal text-gray-400 ml-1">({{ subjectCode }})</span>
              </p>
            </div>
          </div>

          <!-- Term -->
          <div class="flex items-center gap-3 p-3 rounded-lg
                      bg-blue-50 dark:bg-blue-900/10">
            <div class="flex items-center justify-center w-8 h-8 rounded-full
                        bg-blue-100 dark:bg-blue-900/30 flex-shrink-0">
              <mat-icon class="text-blue-600 icon-size-4">date_range</mat-icon>
            </div>
            <div class="min-w-0 flex-1">
              <p class="text-xs text-gray-500 dark:text-gray-400">Term</p>
              <p class="text-sm font-semibold text-gray-900 dark:text-white">{{ termDisplay }}</p>
            </div>
          </div>

          <!-- Assessment (only shown when linked) -->
          <div *ngIf="assessmentDisplay !== '—'"
               class="flex items-center gap-3 p-3 rounded-lg
                      bg-teal-50 dark:bg-teal-900/10">
            <div class="flex items-center justify-center w-8 h-8 rounded-full
                        bg-teal-100 dark:bg-teal-900/30 flex-shrink-0">
              <mat-icon class="text-teal-600 icon-size-4">assignment</mat-icon>
            </div>
            <div class="min-w-0 flex-1">
              <p class="text-xs text-gray-500 dark:text-gray-400">Assessment</p>
              <p class="text-sm font-semibold text-gray-900 dark:text-white truncate">
                {{ assessmentDisplay }}
                <span *ngIf="assessmentTypeLabel"
                      class="text-xs font-normal text-gray-400 ml-1">({{ assessmentTypeLabel }})</span>
              </p>
            </div>
          </div>

          <!-- SuperAdmin school indicator -->
          <div *ngIf="isSuperAdmin && subject.tenantId"
               class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400 pt-1">
            <mat-icon class="icon-size-3 text-gray-400">apartment</mat-icon>
            School selected
          </div>

        </div>
      </mat-card-content>
    </mat-card>

    <!-- ── Score & Grade Card ─────────────────────────────────── -->
    <mat-card class="shadow-md hover:shadow-lg transition-shadow cursor-pointer"
              (click)="editSection.emit(1)">
      <mat-card-header class="!pb-2">
        <div class="flex items-center justify-between w-full">
          <div class="flex items-center gap-3">
            <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-violet-100 dark:bg-violet-900/20">
              <mat-icon class="text-violet-600">grade</mat-icon>
            </div>
            <mat-card-title class="!text-base !font-semibold !mb-0">Score & Grade</mat-card-title>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs font-medium px-2 py-1 rounded bg-green-100 text-green-700
                         dark:bg-green-900/30 dark:text-green-300">✓ Saved</span>
            <mat-icon class="text-gray-400 icon-size-4">edit</mat-icon>
          </div>
        </div>
      </mat-card-header>
      <mat-card-content class="!pt-4">
        <div class="space-y-3">
          <div class="flex justify-between text-sm">
            <span class="text-gray-500 dark:text-gray-400">Score</span>
            <span class="font-semibold text-gray-900 dark:text-white">
              {{ score.score !== null ? score.score : '—' }}
              <span *ngIf="score.maximumScore" class="text-xs text-gray-400">/ {{ score.maximumScore }}</span>
            </span>
          </div>
          <div *ngIf="computedPercentage !== null" class="flex justify-between text-sm">
            <span class="text-gray-500 dark:text-gray-400">Percentage</span>
            <span class="font-bold" [ngClass]="{
              'text-green-600': computedPercentage >= 70,
              'text-amber-600': computedPercentage >= 50 && computedPercentage < 70,
              'text-red-600':   computedPercentage < 50
            }">{{ computedPercentage }}%</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-500 dark:text-gray-400">Grade Letter</span>
            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full text-sm font-bold shadow-sm"
              *ngIf="score.gradeLetter !== null; else noLetter"
              [ngClass]="{
                'bg-green-100 text-green-700': getGradeLetterName(score.gradeLetter).startsWith('A'),
                'bg-blue-100  text-blue-700':  getGradeLetterName(score.gradeLetter).startsWith('B'),
                'bg-amber-100 text-amber-700': getGradeLetterName(score.gradeLetter).startsWith('C'),
                'bg-orange-100 text-orange-700': getGradeLetterName(score.gradeLetter).startsWith('D'),
                'bg-red-100   text-red-700':   getGradeLetterName(score.gradeLetter) === 'E' || getGradeLetterName(score.gradeLetter) === 'F'
              }">
              {{ getGradeLetterName(score.gradeLetter) }}
            </span>
            <ng-template #noLetter><span class="text-gray-400 text-sm">—</span></ng-template>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-500 dark:text-gray-400">Type</span>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold"
              [ngClass]="{
                'bg-blue-100   text-blue-700':   score.gradeType == 0,
                'bg-violet-100 text-violet-700': score.gradeType == 1,
                'bg-teal-100   text-teal-700':   score.gradeType == 2,
                'bg-gray-100   text-gray-600':   score.gradeType == null
              }">
              {{ score.gradeType !== null ? getGradeTypeName(score.gradeType) : '—' }}
            </span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- ── Settings Card (full width) ───────────────────────────── -->
    <mat-card class="shadow-md hover:shadow-lg transition-shadow cursor-pointer lg:col-span-2"
              (click)="editSection.emit(2)">
      <mat-card-header class="!pb-2">
        <div class="flex items-center justify-between w-full">
          <div class="flex items-center gap-3">
            <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-teal-100 dark:bg-teal-900/20">
              <mat-icon class="text-teal-600">settings</mat-icon>
            </div>
            <mat-card-title class="!text-base !font-semibold !mb-0">Status & Remarks</mat-card-title>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs font-medium px-2 py-1 rounded bg-green-100 text-green-700
                         dark:bg-green-900/30 dark:text-green-300">✓ Saved</span>
            <mat-icon class="text-gray-400 icon-size-4">edit</mat-icon>
          </div>
        </div>
      </mat-card-header>
      <mat-card-content class="!pt-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

          <!-- Date -->
          <div class="flex items-center gap-4 p-4 rounded-xl
                      bg-indigo-50 dark:bg-indigo-900/10 border border-indigo-200 dark:border-indigo-800">
            <div class="flex items-center justify-center w-10 h-10 rounded-lg
                        bg-indigo-100 dark:bg-indigo-900/30">
              <mat-icon class="text-indigo-600">event</mat-icon>
            </div>
            <div>
              <p class="text-xs text-gray-500 dark:text-gray-400">Assessment Date</p>
              <p class="font-bold text-indigo-700 dark:text-indigo-300 text-sm">
                {{ settings.assessmentDate | date:'mediumDate' }}
              </p>
            </div>
          </div>

          <!-- Finalized -->
          <div class="flex items-center gap-4 p-4 rounded-xl border"
            [ngClass]="{
              'bg-green-50 dark:bg-green-900/10 border-green-200 dark:border-green-800': settings.isFinalized,
              'bg-gray-50  dark:bg-gray-800/50  border-gray-200  dark:border-gray-700':  !settings.isFinalized
            }">
            <div class="flex items-center justify-center w-10 h-10 rounded-lg"
              [ngClass]="settings.isFinalized ? 'bg-green-100 dark:bg-green-900/30' : 'bg-gray-100 dark:bg-gray-700'">
              <mat-icon [ngClass]="settings.isFinalized ? 'text-green-600' : 'text-gray-400'">
                {{ settings.isFinalized ? 'lock' : 'lock_open' }}
              </mat-icon>
            </div>
            <div>
              <p class="text-xs text-gray-500 dark:text-gray-400">Finalized</p>
              <p class="font-bold text-sm"
                [ngClass]="settings.isFinalized ? 'text-green-700 dark:text-green-300' : 'text-gray-600 dark:text-gray-400'">
                {{ settings.isFinalized ? 'Yes — Locked' : 'No — Editable' }}
              </p>
            </div>
          </div>

          <!-- Remarks -->
          <div class="flex items-center gap-4 p-4 rounded-xl
                      bg-blue-50 dark:bg-blue-900/10 border border-blue-200 dark:border-blue-800">
            <div class="flex items-center justify-center w-10 h-10 rounded-lg
                        bg-blue-100 dark:bg-blue-900/30">
              <mat-icon class="text-blue-600">notes</mat-icon>
            </div>
            <div class="min-w-0 flex-1">
              <p class="text-xs text-gray-500 dark:text-gray-400">Remarks</p>
              <p class="font-bold text-blue-700 dark:text-blue-300 text-sm truncate">
                {{ settings.remarks ? settings.remarks : 'None added' }}
              </p>
            </div>
          </div>

        </div>
      </mat-card-content>
    </mat-card>

  </div>
</div>