<!-- details/grade-details.component.html -->
<div class="absolute inset-0 flex min-w-0 flex-col overflow-y-auto" cdkScrollable>

  <app-page-header
    [title]="grade ? (grade.studentName || 'Grade Details') : 'Grade Details'"
    [description]="grade ? ('Subject: ' + (grade.subjectName || '—') + ' · ' + (grade.termName || 'No term')) : 'Loading...'"
    icon="grade"
    [breadcrumbs]="breadcrumbs"
    [actionTemplate]="headerActions">
  </app-page-header>

  <ng-template #headerActions>
    <button mat-stroked-button
      class="mr-3 border-gray-300 text-gray-700 hover:bg-gray-50 dark:border-gray-600 dark:text-gray-300"
      (click)="goBack()">
      <mat-icon class="icon-size-5">arrow_back</mat-icon>
      <span class="ml-2">Back to List</span>
    </button>

    <button mat-flat-button
      class="mr-3 bg-indigo-600 text-white hover:bg-indigo-700"
      [disabled]="!grade || grade.isFinalized"
      (click)="editGrade()">
      <mat-icon class="icon-size-5">edit</mat-icon>
      <span class="ml-2">Edit Grade</span>
    </button>

    <button mat-icon-button [matMenuTriggerFor]="actionsMenu" [disabled]="!grade"
      class="text-gray-600 dark:text-gray-400">
      <mat-icon>more_vert</mat-icon>
    </button>

    <mat-menu #actionsMenu="matMenu">
      <button mat-menu-item [disabled]="grade?.isFinalized" (click)="finalizeGrade()">
        <mat-icon class="text-green-600">lock</mat-icon>
        <span>Finalize Grade</span>
      </button>
      <mat-divider></mat-divider>
      <button mat-menu-item [disabled]="grade?.isFinalized" (click)="deleteGrade()">
        <mat-icon class="text-red-600">delete</mat-icon>
        <span class="text-red-600">Delete Grade</span>
      </button>
    </mat-menu>
  </ng-template>

  <!-- ── Main Content ─────────────────────────────────────────────────── -->
  <div class="bg-card -mt-10 flex-auto rounded-t-2xl p-6 shadow sm:p-10">

    <!-- Loading -->
    <div *ngIf="isLoading" class="flex items-center justify-center py-32">
      <div class="text-center">
        <mat-spinner diameter="48" class="mx-auto mb-4"></mat-spinner>
        <p class="text-sm text-gray-500 dark:text-gray-400">Loading grade details...</p>
      </div>
    </div>

    <!-- Content -->
    <div *ngIf="!isLoading && grade" class="animate-fade-in">

      <!-- ── Hero Card ─────────────────────────────────────────────── -->
      <div class="mb-8 overflow-hidden rounded-2xl border border-gray-200 shadow-lg dark:border-gray-700">
        <div class="bg-gradient-to-r from-indigo-600 via-violet-600 to-purple-600 px-8 py-6">
          <div class="flex flex-col items-center gap-6 md:flex-row">

            <!-- Icon / Grade Letter -->
            <div class="flex items-center justify-center w-24 h-24 rounded-2xl
                        bg-white/20 backdrop-blur-sm border-4 border-white/30 shadow-2xl">
              <span *ngIf="grade.gradeLetter; else gradeIcon"
                class="text-4xl font-black text-white">
                {{ getGradeLetterName(grade.gradeLetter) }}
              </span>
              <ng-template #gradeIcon>
                <mat-icon class="text-white icon-size-12">grade</mat-icon>
              </ng-template>
            </div>

            <!-- Info -->
            <div class="flex-1 text-center md:text-left">
              <h1 class="mb-2 text-3xl font-bold text-white">{{ grade.studentName || 'Unknown Student' }}</h1>
              <div class="mb-4 flex flex-wrap items-center justify-center gap-3 md:justify-start">
                <span class="inline-flex items-center gap-1 rounded-lg bg-white/20 px-3 py-1
                             text-sm font-medium text-white backdrop-blur-sm">
                  <mat-icon class="icon-size-4">menu_book</mat-icon>
                  {{ grade.subjectName || 'Unknown Subject' }}
                </span>
                <span class="inline-flex items-center gap-1 rounded-lg bg-white/20 px-3 py-1
                             text-sm font-medium text-white backdrop-blur-sm">
                  <mat-icon class="icon-size-4">category</mat-icon>
                  {{ getGradeTypeName(grade.gradeType) }}
                </span>
                <span *ngIf="grade.termName"
                  class="inline-flex items-center gap-1 rounded-lg bg-white/20 px-3 py-1
                         text-sm font-medium text-white backdrop-blur-sm">
                  <mat-icon class="icon-size-4">date_range</mat-icon>
                  {{ grade.termName }}
                </span>
              </div>
              <p *ngIf="grade.remarks" class="text-sm text-white/80 max-w-xl italic">
                "{{ grade.remarks }}"
              </p>
            </div>

            <!-- Score + Status -->
            <div class="flex flex-col items-center gap-3">
              <div *ngIf="grade.percentage !== null"
                   class="flex flex-col items-center justify-center w-20 h-20 rounded-2xl
                          bg-white/20 backdrop-blur-sm border-2 border-white/30">
                <span class="text-2xl font-black text-white">{{ grade.percentage }}%</span>
                <span class="text-xs text-white/70">Score</span>
              </div>
              <span class="flex items-center gap-1 rounded-full px-4 py-2 text-sm font-bold shadow-lg"
                [ngClass]="{
                  'bg-green-500 text-white': grade.isFinalized,
                  'bg-amber-400 text-white': !grade.isFinalized
                }">
                <mat-icon class="icon-size-4">{{ grade.isFinalized ? 'lock' : 'hourglass_top' }}</mat-icon>
                {{ grade.isFinalized ? 'Finalized' : 'Pending' }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- ── Quick Stats ─────────────────────────────────────────────── -->
      <div class="mb-8 grid gap-4 sm:grid-cols-2 lg:grid-cols-4">

        <div class="rounded-xl border border-indigo-200 bg-gradient-to-br from-indigo-50 to-white p-4
                    dark:border-indigo-800 dark:from-indigo-900/20 dark:to-gray-800">
          <div class="flex items-center gap-3">
            <div class="rounded-lg bg-indigo-100 p-3 dark:bg-indigo-900/40">
              <mat-icon class="text-indigo-600 dark:text-indigo-400 icon-size-6">numbers</mat-icon>
            </div>
            <div>
              <p class="text-xs text-gray-600 dark:text-gray-400">Score</p>
              <p class="text-sm font-bold text-gray-900 dark:text-white">
                {{ grade.score !== null ? grade.score : '—' }}
                <span *ngIf="grade.maximumScore" class="text-xs font-normal text-gray-400">/ {{ grade.maximumScore }}</span>
              </p>
            </div>
          </div>
        </div>

        <div class="rounded-xl border border-violet-200 bg-gradient-to-br from-violet-50 to-white p-4
                    dark:border-violet-800 dark:from-violet-900/20 dark:to-gray-800">
          <div class="flex items-center gap-3">
            <div class="rounded-lg bg-violet-100 p-3 dark:bg-violet-900/40">
              <mat-icon class="text-violet-600 dark:text-violet-400 icon-size-6">percent</mat-icon>
            </div>
            <div>
              <p class="text-xs text-gray-600 dark:text-gray-400">Percentage</p>
              <p class="text-sm font-bold text-gray-900 dark:text-white">
                {{ grade.percentage !== null ? (grade.percentage + '%') : '—' }}
              </p>
            </div>
          </div>
        </div>

        <div class="rounded-xl border border-amber-200 bg-gradient-to-br from-amber-50 to-white p-4
                    dark:border-amber-800 dark:from-amber-900/20 dark:to-gray-800">
          <div class="flex items-center gap-3">
            <div class="rounded-lg bg-amber-100 p-3 dark:bg-amber-900/40">
              <mat-icon class="text-amber-600 dark:text-amber-400 icon-size-6">trending_up</mat-icon>
            </div>
            <div>
              <p class="text-xs text-gray-600 dark:text-gray-400">Performance</p>
              <p class="text-sm font-bold text-gray-900 dark:text-white">
                {{ getPerformanceName(grade.percentage) }}
              </p>
            </div>
          </div>
        </div>

        <div class="rounded-xl border border-blue-200 bg-gradient-to-br from-blue-50 to-white p-4
                    dark:border-blue-800 dark:from-blue-900/20 dark:to-gray-800">
          <div class="flex items-center gap-3">
            <div class="rounded-lg bg-blue-100 p-3 dark:bg-blue-900/40">
              <mat-icon class="text-blue-600 dark:text-blue-400 icon-size-6">school</mat-icon>
            </div>
            <div>
              <p class="text-xs text-gray-600 dark:text-gray-400">School</p>
              <p class="text-sm font-bold text-gray-900 dark:text-white truncate max-w-[120px]">
                {{ grade.schoolName || 'N/A' }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- ── Details Grid ─────────────────────────────────────────────── -->
      <div class="rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div class="bg-gray-50 dark:bg-gray-800/50 px-6 py-4 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-base font-semibold text-gray-900 dark:text-white flex items-center gap-2">
            <mat-icon class="text-indigo-600 icon-size-5">info</mat-icon>
            Grade Details
          </h3>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-px bg-gray-200 dark:bg-gray-700">
          <div *ngFor="let item of detailItems; trackBy: trackByLabel"
               class="group bg-white dark:bg-gray-800 p-5 transition-all hover:bg-indigo-50 dark:hover:bg-indigo-900/10">
            <div class="flex items-start justify-between">
              <div class="flex-1 min-w-0">
                <div class="mb-1 flex items-center gap-2">
                  <mat-icon *ngIf="item.icon" class="text-gray-400 icon-size-4">{{ item.icon }}</mat-icon>
                  <p class="text-xs font-medium uppercase tracking-wide text-gray-500 dark:text-gray-400">
                    {{ item.label }}
                  </p>
                </div>

                <!-- Badge -->
                <span *ngIf="item.type === 'badge'"
                  class="inline-flex items-center rounded-lg bg-indigo-100 dark:bg-indigo-900/30
                         px-3 py-1 text-sm font-bold text-indigo-700 dark:text-indigo-300">
                  {{ item.value || '—' }}
                </span>

                <!-- Status (Finalized/Pending) -->
                <span *ngIf="item.type === 'status'"
                  class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold"
                  [ngClass]="{
                    'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300': item.value === 'Finalized',
                    'bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300': item.value === 'Pending'
                  }">
                  {{ item.value }}
                </span>

                <!-- Boolean -->
                <span *ngIf="item.type === 'boolean'"
                  class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold"
                  [ngClass]="{
                    'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300': item.value === 'Yes',
                    'bg-gray-100  dark:bg-gray-700      text-gray-600  dark:text-gray-400':  item.value === 'No'
                  }">
                  <mat-icon class="icon-size-3 mr-1">{{ item.value === 'Yes' ? 'lock' : 'lock_open' }}</mat-icon>
                  {{ item.value }}
                </span>

                <!-- Text / Date -->
                <p *ngIf="!item.type || item.type === 'text' || item.type === 'date' || item.type === 'percent'"
                  class="text-sm font-semibold text-gray-900 dark:text-white break-words">
                  {{ item.value || '—' }}
                </p>
              </div>

              <!-- Copy -->
              <button *ngIf="item.copyable && item.value"
                mat-icon-button
                class="opacity-0 group-hover:opacity-100 transition-opacity shrink-0"
                (click)="copyToClipboard(item.value)"
                matTooltip="Copy to clipboard">
                <mat-icon class="text-gray-400 hover:text-indigo-600 icon-size-4">content_copy</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>