<div class="flex flex-col w-full max-w-2xl">

  <!-- ── Dialog Header ───────────────────────────────────────────────────── -->
  <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700
              bg-gradient-to-r from-indigo-600 to-violet-700 rounded-t-2xl">
    <div class="flex items-center gap-3">
      <div class="flex items-center justify-center w-9 h-9 rounded-xl bg-white/20 backdrop-blur-sm">
        <mat-icon class="text-white icon-size-5">account_balance</mat-icon>
      </div>
      <div>
        <h2 class="text-lg font-bold text-white leading-tight">{{ title }}</h2>
        <p class="text-xs text-indigo-200">
          {{ isEdit ? 'Update amount, level, and validity settings' : 'Define a fee amount for a specific context' }}
        </p>
      </div>
    </div>
    <button mat-icon-button (click)="cancel()" class="text-white hover:bg-white/20 rounded-xl transition">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- ── Loading Lookups Indicator ───────────────────────────────────────── -->
  <div *ngIf="isLoadingLookups"
       class="flex items-center justify-center gap-3 px-6 py-3 bg-indigo-50 dark:bg-indigo-900/20 border-b border-indigo-100 dark:border-indigo-800">
    <mat-spinner diameter="18"></mat-spinner>
    <span class="text-xs text-indigo-600 dark:text-indigo-300 font-medium">Loading fee items, years & terms…</span>
  </div>

  <!-- ── Form ────────────────────────────────────────────────────────────── -->
  <form [formGroup]="form" (ngSubmit)="save()" class="overflow-y-auto max-h-[70vh]">
    <div class="px-6 py-5 space-y-5">

      <!-- Section: Reference data (immutable on edit) -->
      <div>
        <p class="text-xs font-semibold uppercase tracking-wider text-gray-400 dark:text-gray-500 mb-3">
          Fee Reference
          <span *ngIf="isEdit" class="ml-2 px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 text-xs font-medium normal-case tracking-normal">
            Read-only after creation
          </span>
        </p>

        <!-- Fee Item -->
        <div class="mb-4">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Fee Item</mat-label>
            <mat-select formControlName="feeItemId" placeholder="Select fee item">
              <mat-option *ngFor="let item of feeItems" [value]="item.id">
                <span class="font-medium">{{ item.name }}</span>
                <span class="ml-2 text-xs text-gray-400 font-mono">{{ item.code }}</span>
              </mat-option>
            </mat-select>
            <mat-icon matPrefix class="text-gray-400 mr-2 icon-size-4">receipt_long</mat-icon>
            <mat-error *ngIf="fieldError('feeItemId')">{{ fieldError('feeItemId') }}</mat-error>
          </mat-form-field>
        </div>

        <!-- Academic Year + Term -->
        <div class="grid grid-cols-2 gap-4">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Academic Year</mat-label>
            <mat-select formControlName="academicYearId" placeholder="Select year">
              <mat-option *ngFor="let yr of academicYears" [value]="yr.id">{{ yr.name }}</mat-option>
            </mat-select>
            <mat-icon matPrefix class="text-gray-400 mr-2 icon-size-4">calendar_today</mat-icon>
            <mat-error *ngIf="fieldError('academicYearId')">{{ fieldError('academicYearId') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Term <span class="text-gray-400">(optional)</span></mat-label>
            <mat-select formControlName="termId" placeholder="Annual / all terms">
              <mat-option [value]="null">— Annual fee (no term) —</mat-option>
              <mat-option *ngFor="let t of filteredTerms" [value]="t.id">{{ t.name }}</mat-option>
            </mat-select>
            <mat-icon matPrefix class="text-gray-400 mr-2 icon-size-4">date_range</mat-icon>
          </mat-form-field>
        </div>
      </div>

      <!-- Divider -->
      <div class="border-t border-dashed border-gray-200 dark:border-gray-700"></div>

      <!-- Section: CBC Targeting -->
      <div>
        <p class="text-xs font-semibold uppercase tracking-wider text-gray-400 dark:text-gray-500 mb-3">
          CBC Targeting
        </p>

        <div class="grid grid-cols-2 gap-4">
          <!-- CBC Level -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>CBC Level <span class="text-gray-400">(optional)</span></mat-label>
            <mat-select formControlName="level" placeholder="All levels">
              <mat-option [value]="null">— All Levels —</mat-option>
              <mat-option *ngFor="let opt of levelOptions" [value]="opt.value">{{ opt.label }}</mat-option>
            </mat-select>
            <mat-icon matPrefix class="text-gray-400 mr-2 icon-size-4">school</mat-icon>
          </mat-form-field>

          <!-- Applicable To -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Applicable To</mat-label>
            <mat-select formControlName="applicableTo">
              <mat-option *ngFor="let opt of applicableOptions" [value]="opt.value">{{ opt.label }}</mat-option>
            </mat-select>
            <mat-icon matPrefix class="text-gray-400 mr-2 icon-size-4">group</mat-icon>
            <mat-error *ngIf="fieldError('applicableTo')">{{ fieldError('applicableTo') }}</mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Divider -->
      <div class="border-t border-dashed border-gray-200 dark:border-gray-700"></div>

      <!-- Section: Amount -->
      <div>
        <p class="text-xs font-semibold uppercase tracking-wider text-gray-400 dark:text-gray-500 mb-3">
          Amount & Discounts
        </p>

        <div class="grid grid-cols-2 gap-4">
          <!-- Amount -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Amount (KES)</mat-label>
            <input matInput type="number" formControlName="amount"
                   placeholder="0.00" min="0.01" step="0.01">
            <span matPrefix class="text-gray-500 font-semibold mr-1 text-sm">KES</span>
            <mat-error *ngIf="fieldError('amount')">{{ fieldError('amount') }}</mat-error>
          </mat-form-field>

          <!-- Max Discount % -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Max Discount % <span class="text-gray-400">(optional)</span></mat-label>
            <input matInput type="number" formControlName="maxDiscountPercent"
                   placeholder="e.g. 10" min="0" max="100" step="0.5">
            <mat-icon matSuffix class="text-gray-400 icon-size-4">percent</mat-icon>
            <mat-hint>Leave blank to disallow discounts</mat-hint>
            <mat-error *ngIf="fieldError('maxDiscountPercent')">{{ fieldError('maxDiscountPercent') }}</mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Divider -->
      <div class="border-t border-dashed border-gray-200 dark:border-gray-700"></div>

      <!-- Section: Validity -->
      <div>
        <p class="text-xs font-semibold uppercase tracking-wider text-gray-400 dark:text-gray-500 mb-3">
          Validity Period <span class="font-normal normal-case tracking-normal text-gray-400">(optional)</span>
        </p>

        <div class="grid grid-cols-2 gap-4">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Effective From</mat-label>
            <input matInput [matDatepicker]="fromPicker" formControlName="effectiveFrom" placeholder="mm/dd/yyyy">
            <mat-datepicker-toggle matSuffix [for]="fromPicker"></mat-datepicker-toggle>
            <mat-datepicker #fromPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Effective To</mat-label>
            <input matInput [matDatepicker]="toPicker" formControlName="effectiveTo" placeholder="mm/dd/yyyy">
            <mat-datepicker-toggle matSuffix [for]="toPicker"></mat-datepicker-toggle>
            <mat-datepicker #toPicker></mat-datepicker>
          </mat-form-field>
        </div>

        <!-- Is Active -->
        <div class="flex items-center gap-3 mt-3 px-1">
          <mat-checkbox formControlName="isActive" color="primary">
            <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Active</span>
          </mat-checkbox>
          <span class="text-xs text-gray-400">
            Inactive fee structures are excluded from new invoice generation.
          </span>
        </div>
      </div>

    </div>

    <!-- ── Dialog Footer ───────────────────────────────────────────────────── -->
    <div class="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 dark:border-gray-700
                bg-gray-50 dark:bg-gray-800/50 rounded-b-2xl sticky bottom-0">
      <button type="button" mat-stroked-button (click)="cancel()"
              class="rounded-xl border-gray-300 text-gray-600 hover:border-gray-400 dark:border-gray-600 dark:text-gray-300"
              [disabled]="isSaving">
        Cancel
      </button>
      <button type="submit" mat-flat-button
              class="rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 min-w-[120px]"
              [disabled]="isSaving || isLoadingLookups">
        <ng-container *ngIf="!isSaving; else savingTpl">
          <mat-icon class="icon-size-4 mr-1">{{ isEdit ? 'save' : 'add_circle' }}</mat-icon>
          {{ isEdit ? 'Save Changes' : 'Create' }}
        </ng-container>
        <ng-template #savingTpl>
          <mat-spinner diameter="18" class="inline-block mr-2"></mat-spinner>
          Saving…
        </ng-template>
      </button>
    </div>
  </form>

</div>