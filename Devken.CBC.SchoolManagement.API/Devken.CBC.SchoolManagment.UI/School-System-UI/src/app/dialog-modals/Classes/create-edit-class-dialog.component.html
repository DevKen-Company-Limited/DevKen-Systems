<!-- Dialog Header with Gradient -->
<div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 -m-6 mb-0 p-6 relative overflow-hidden">
  <div class="absolute inset-0 opacity-10">
    <div class="absolute top-0 right-0 w-32 h-32 bg-yellow-200 rounded-full blur-2xl"></div>
    <div class="absolute bottom-0 left-0 w-40 h-40 bg-cyan-300 rounded-full blur-2xl"></div>
  </div>
  
  <div class="relative z-10 flex items-center gap-3">
    <div class="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
      <mat-icon class="text-white icon-size-6">{{ isEditMode ? 'edit' : 'add_circle' }}</mat-icon>
    </div>
    <div>
      <h2 class="text-2xl font-bold text-white m-0">{{ dialogTitle }}</h2>
      <p class="text-white/80 text-sm mt-1">{{ dialogSubtitle }}</p>
    </div>
  </div>
  <button
    mat-icon-button
    class="close-btn absolute top-3 right-3 text-white z-20"
    (click)="cancel()"
    matTooltip="Close">
    <mat-icon>close</mat-icon>
  </button>
</div>

<!-- Main form -->
<form [formGroup]="form" (ngSubmit)="submit()" mat-dialog-content class="p-4">
  
  <!-- Validation Errors -->
  <div 
    *ngIf="form.invalid && (form.touched || form.dirty)" 
    class="mb-4 p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 rounded-lg">
    <div class="flex items-center gap-2 text-red-800 dark:text-red-200">
      <mat-icon class="icon-size-5">error_outline</mat-icon>
      <span class="font-medium">Please fix the following errors:</span>
    </div>
    <ul class="mt-1 ml-6 text-sm text-red-700 dark:text-red-300 list-disc">
      <li *ngIf="form.get('schoolId')?.hasError('required')">School is required</li>
      <li *ngIf="form.get('name')?.hasError('required')">Class name is required</li>
      <li *ngIf="form.get('level')?.hasError('required')">CBC Level is required</li>
      <li *ngIf="form.get('academicYearId')?.hasError('required')">Academic Year is required</li>
      <li *ngIf="form.get('capacity')?.hasError('min')">Capacity must be at least 1</li>
      <li *ngIf="form.get('capacity')?.hasError('max')">Capacity cannot exceed 100</li>
    </ul>
  </div>

  <!-- School Selection - Full Width at Top (SuperAdmin Only) -->
  <div *ngIf="isSuperAdmin" class="mb-4">
    <mat-form-field appearance="outline" class="w-full">
      <mat-label>School</mat-label>
      <mat-select formControlName="schoolId" placeholder="Select school">
        <!-- Loading indicator -->
        <mat-option *ngIf="isLoadingSchools" [value]="" disabled>
          <div class="flex items-center gap-2">
            <mat-spinner diameter="16"></mat-spinner>
            <span>Loading schools...</span>
          </div>
        </mat-option>
        <!-- Empty message -->
        <mat-option *ngIf="!isLoadingSchools && schools.length === 0" [value]="" disabled>
          <div class="flex items-center gap-2 text-orange-600">
            <mat-icon class="icon-size-4">warning</mat-icon>
            <span>No schools found</span>
          </div>
        </mat-option>
        <!-- School options -->
        <mat-option *ngFor="let school of schools" [value]="school.id">
          {{ school.name }} ({{ school.code }})
        </mat-option>
      </mat-select>
      <mat-icon matPrefix>business</mat-icon>
      <mat-hint>
        <span *ngIf="isLoadingSchools" class="flex items-center gap-1">
          <mat-spinner diameter="12"></mat-spinner>
          Loading schools...
        </span>
        <span *ngIf="!isLoadingSchools && schools.length === 0" class="text-orange-600">
          No schools available. Please create a school first.
        </span>
        <span *ngIf="!isLoadingSchools && schools.length > 0 && isEditMode" class="text-gray-500">
          School cannot be changed in edit mode
        </span>
        <span *ngIf="!isLoadingSchools && schools.length > 0 && !isEditMode">
          Select the school for this class
        </span>
      </mat-hint>
      <mat-error *ngIf="form.get('schoolId')?.hasError('required')">
        School is required
      </mat-error>
    </mat-form-field>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- Left Column -->
    <div class="space-y-4">
      <!-- Class Name -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Class Name</mat-label>
        <input 
          matInput 
          formControlName="name" 
          placeholder="e.g., Grade 1 Blue"
          autocomplete="off">
        <mat-icon matPrefix>school</mat-icon>
        <mat-error *ngIf="form.get('name')?.hasError('required')">
          Class name is required
        </mat-error>
        <mat-error *ngIf="form.get('name')?.hasError('minlength')">
          Class name must be at least 2 characters
        </mat-error>
      </mat-form-field>

      <!-- Class Code with Number Series Integration -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Class Code</mat-label>
        <input 
          matInput 
          formControlName="code" 
          placeholder="Auto-generated if empty"
          autocomplete="off"
          style="text-transform: uppercase;">
        <mat-icon matPrefix>tag</mat-icon>
        
        <!-- Show preview or use generated code button -->
        <button 
          *ngIf="showCodePreview"
          mat-icon-button 
          matSuffix 
          type="button"
          (click)="useGeneratedCode()"
          matTooltip="Use auto-generated code: {{ codePreview }}">
          <mat-icon>auto_fix_high</mat-icon>
        </button>
        
        <!-- Fallback manual generation -->
        <button 
          *ngIf="!isEditMode && !showCodePreview"
          mat-icon-button 
          matSuffix 
          type="button"
          (click)="generateCode()"
          matTooltip="Generate code from level and name">
          <mat-icon>refresh</mat-icon>
        </button>

        <mat-hint *ngIf="!isEditMode && !form.get('code')?.value">
          <span *ngIf="isLoadingPreview">Loading preview...</span>
          <span *ngIf="!isLoadingPreview && codePreview">
            Auto-generated: <strong>{{ codePreview }}</strong>
          </span>
          <span *ngIf="!isLoadingPreview && !codePreview">
            Will be auto-generated if left empty
          </span>
        </mat-hint>
        <mat-hint *ngIf="form.get('code')?.value" align="end">
          {{ form.get('code')?.value?.length || 0 }}/20
        </mat-hint>
      </mat-form-field>

      <!-- CBC Level -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>CBC Level</mat-label>
        <mat-select formControlName="level">
          <mat-option *ngFor="let level of cbcLevels" [value]="level.value">
            {{ level.label }}
          </mat-option>
        </mat-select>
        <mat-icon matPrefix>school</mat-icon>
        <mat-error *ngIf="form.get('level')?.hasError('required')">
          CBC Level is required
        </mat-error>
      </mat-form-field>

      <!-- Capacity -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Capacity</mat-label>
        <input 
          matInput 
          type="number" 
          formControlName="capacity" 
          min="1" 
          max="100"
          autocomplete="off">
        <mat-icon matPrefix>groups</mat-icon>
        <mat-hint>Maximum number of students (1-100)</mat-hint>
        <mat-error *ngIf="form.get('capacity')?.hasError('required')">
          Capacity is required
        </mat-error>
        <mat-error *ngIf="form.get('capacity')?.hasError('min')">
          Capacity must be at least 1
        </mat-error>
        <mat-error *ngIf="form.get('capacity')?.hasError('max')">
          Capacity cannot exceed 100
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Right Column -->
    <div class="space-y-4">
      <!-- Academic Year -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Academic Year</mat-label>
        <mat-select formControlName="academicYearId" placeholder="Select academic year">
          <!-- Loading indicator -->
          <mat-option *ngIf="isLoadingAcademicYears" [value]="" disabled>
            <div class="flex items-center gap-2">
              <mat-spinner diameter="16"></mat-spinner>
              <span>Loading academic years...</span>
            </div>
          </mat-option>
          <!-- Empty message -->
          <mat-option *ngIf="!isLoadingAcademicYears && filteredAcademicYears.length === 0" [value]="" disabled>
            <div class="flex items-center gap-2 text-orange-600">
              <mat-icon class="icon-size-4">warning</mat-icon>
              <span>No academic years found</span>
            </div>
          </mat-option>
          <!-- Academic year options -->
          <mat-option *ngFor="let year of filteredAcademicYears" [value]="year.id">
            {{ year.name }} ({{ year.code }})
          </mat-option>
        </mat-select>
        <mat-icon matPrefix>calendar_today</mat-icon>
        <mat-hint>
          <span *ngIf="isLoadingAcademicYears" class="flex items-center gap-1">
            <mat-spinner diameter="12"></mat-spinner>
            Loading academic years...
          </span>
          <span *ngIf="!isLoadingAcademicYears && isSuperAdmin && !form.get('schoolId')?.value" class="text-gray-500">
            Please select a school first
          </span>
          <span *ngIf="!isLoadingAcademicYears && filteredAcademicYears.length === 0 && form.get('schoolId')?.value" class="text-orange-600">
            No academic years available for this school
          </span>
          <span *ngIf="!isLoadingAcademicYears && filteredAcademicYears.length > 0">
            Select the academic year
          </span>
        </mat-hint>
        <mat-error *ngIf="form.get('academicYearId')?.hasError('required')">
          Academic Year is required
        </mat-error>
      </mat-form-field>

      <!-- Class Teacher -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Class Teacher (Optional)</mat-label>
        <mat-select formControlName="teacherId">
          <mat-option [value]="''">-- No Teacher Assigned --</mat-option>
          <!-- Loading indicator -->
          <mat-option *ngIf="isLoadingTeachers" [value]="" disabled>
            <div class="flex items-center gap-2">
              <mat-spinner diameter="16"></mat-spinner>
              <span>Loading teachers...</span>
            </div>
          </mat-option>
          <!-- Empty message -->
          <mat-option *ngIf="!isLoadingTeachers && filteredTeachers.length === 0" [value]="" disabled>
            <div class="flex items-center gap-2 text-gray-500">
              <mat-icon class="icon-size-4">info</mat-icon>
              <span>No teachers found</span>
            </div>
          </mat-option>
          <!-- Teacher options -->
          <mat-option *ngFor="let teacher of filteredTeachers" [value]="teacher.id">
            {{ teacher.firstName }} {{ teacher.lastName }} ({{ teacher.teacherNumber }})
          </mat-option>
        </mat-select>
        <mat-icon matPrefix>person</mat-icon>
        <mat-hint>
          <span *ngIf="isLoadingTeachers" class="flex items-center gap-1">
            <mat-spinner diameter="12"></mat-spinner>
            Loading teachers...
          </span>
          <span *ngIf="!isLoadingTeachers && isSuperAdmin && !form.get('schoolId')?.value" class="text-gray-500">
            Please select a school first
          </span>
          <span *ngIf="!isLoadingTeachers && filteredTeachers.length === 0 && form.get('schoolId')?.value" class="text-orange-600">
            No teachers available for this school
          </span>
          <span *ngIf="!isLoadingTeachers && filteredTeachers.length > 0">
            Assign a class teacher (optional)
          </span>
        </mat-hint>
      </mat-form-field>

      <!-- Description -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Description (Optional)</mat-label>
        <textarea 
          matInput 
          formControlName="description" 
          placeholder="Brief description of the class..."
          rows="4"
          maxlength="500"></textarea>
        <mat-icon matPrefix>description</mat-icon>
        <mat-hint align="end">{{ form.get('description')?.value?.length || 0 }}/500</mat-hint>
        <mat-error *ngIf="form.get('description')?.hasError('maxlength')">
          Description cannot exceed 500 characters
        </mat-error>
      </mat-form-field>

      <!-- Active Status -->
      <div class="border-2 border-gray-200 dark:border-gray-700 rounded-lg p-4 bg-gray-50 dark:bg-gray-800/50">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <mat-icon class="text-green-600 icon-size-5">check_circle</mat-icon>
            <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">Active Status</span>
          </div>
          <mat-checkbox 
            formControlName="isActive"
            color="primary"
            class="font-medium">
            {{ form.get('isActive')?.value ? 'Active' : 'Inactive' }}
          </mat-checkbox>
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
          Inactive classes are hidden from student enrollment
        </p>
      </div>
    </div>
  </div>
</form>

<!-- Dialog Actions -->
<div mat-dialog-actions class="flex justify-end gap-3 mt-6">
  <button mat-button type="button" (click)="cancel()" [disabled]="isSaving">Cancel</button>
  <button mat-flat-button color="primary" type="button" (click)="submit()" [disabled]="form.invalid || isSaving">
    <mat-icon *ngIf="isSaving" class="icon-size-5 mr-2">hourglass_empty</mat-icon>
    <mat-icon *ngIf="!isSaving" class="icon-size-5 mr-2">{{ isEditMode ? 'save' : 'add' }}</mat-icon>
    {{ isSaving ? 'Saving...' : (isEditMode ? 'Save' : 'Create') }}
  </button>
</div>