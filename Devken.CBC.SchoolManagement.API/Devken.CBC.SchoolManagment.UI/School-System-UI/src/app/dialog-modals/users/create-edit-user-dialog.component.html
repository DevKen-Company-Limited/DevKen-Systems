<!-- ═══════════════════════════════════════════════════════════════════════ -->
<!-- User Dialog — Redesigned in Teacher Dialog Style                       -->
<!-- ═══════════════════════════════════════════════════════════════════════ -->

<!-- ── Gradient Header ──────────────────────────────────────────────────── -->
<div class="dialog-header">
  <div class="header-left">
    <div class="header-icon-ring">
      <mat-icon class="header-icon">{{ isEditMode ? 'edit' : 'person_add' }}</mat-icon>
    </div>
    <div class="header-text">
      <h2 class="header-title">{{ dialogTitle }}</h2>
      <p class="header-subtitle">
        {{ isEditMode ? 'Update user information and roles' : 'Add a new user to the system' }}
      </p>
    </div>
  </div>
  <button mat-icon-button class="close-btn" (click)="onCancel()" matTooltip="Close">
    <mat-icon>close</mat-icon>
  </button>
</div>

<!-- ── Loading Overlay ──────────────────────────────────────────────────── -->
<div *ngIf="isLoadingRoles || isLoadingSchools" class="loading-overlay">
  <div class="loading-content">
    <div class="loading-spinner-wrap">
      <mat-spinner diameter="44" class="primary-spinner"></mat-spinner>
      <mat-icon class="loading-icon">manage_accounts</mat-icon>
    </div>
    <p class="loading-title">Preparing Form…</p>
    <p class="loading-sub">Loading roles and configuration</p>
  </div>
</div>

<!-- ── Body ─────────────────────────────────────────────────────────────── -->
<div class="dialog-body" [class.hidden]="isLoadingRoles || isLoadingSchools">

  <!-- ── Left: Avatar Panel ─────────────────────────────────────────────── -->
  <div class="avatar-panel">
    <div class="avatar-wrap">
      <div class="avatar-circle">
        <mat-icon class="avatar-icon">{{ isEditMode ? 'manage_accounts' : 'person_add' }}</mat-icon>
      </div>
      <div class="avatar-badge" [class.edit-mode]="isEditMode">
        {{ isEditMode ? 'Edit' : 'New' }}
      </div>
    </div>

    <div class="user-mode-label">
      <p class="mode-title">{{ isEditMode ? 'Editing User' : 'Creating User' }}</p>
      <p class="mode-sub">{{ isEditMode ? 'Modify existing account' : 'New system account' }}</p>
    </div>

    <!-- Info Card -->
    <div class="info-card">
      <mat-icon class="info-icon">info</mat-icon>
      <p>{{ isEditMode
        ? 'Email cannot be changed after account creation.'
        : 'A welcome email can be sent automatically after creation.'
      }}</p>
    </div>
  </div>

  <!-- ── Right: Tabbed Form ─────────────────────────────────────────────── -->
  <div class="form-panel">

    <!-- Tab Bar -->
    <div class="tab-bar" role="tablist">
      <button *ngFor="let tab of tabs; let i = index"
              type="button"
              role="tab"
              class="tab-btn"
              [class.active]="activeTab === tab.id"
              [class.has-error]="tabHasErrors(tab)"
              (click)="setTab(tab.id)"
              [attr.aria-selected]="activeTab === tab.id">
        <mat-icon class="tab-icon">{{ tab.icon }}</mat-icon>
        <span class="tab-label">{{ tab.label }}</span>
        <span *ngIf="tabHasErrors(tab)" class="tab-error-dot"></span>
      </button>
    </div>

    <!-- ── Tab Content ─────────────────────────────────────────────────── -->
    <form [formGroup]="form" class="form-content" novalidate>

      <!-- ══ IDENTITY TAB ══ -->
      <div *ngIf="activeTab === 'identity'" class="tab-pane" role="tabpanel">

        <!-- School Selection (SuperAdmin Only, Create Mode) -->
        <div *ngIf="showSchoolSelection" class="school-section">
          <div class="section-label">
            <mat-icon>school</mat-icon>
            <span>School Assignment</span>
          </div>
          <mat-form-field appearance="outline" class="field w-full">
            <mat-label>School <span class="req">*</span></mat-label>
            <mat-icon matPrefix class="field-prefix-icon">business</mat-icon>
            <mat-select formControlName="schoolId">
              <mat-option [value]="null">— Select School —</mat-option>
              <mat-option *ngFor="let school of availableSchools" [value]="school.id">
                <span class="school-name">{{ school.name }}</span>
                <span *ngIf="school.location" class="school-location"> · {{ school.location }}</span>
              </mat-option>
            </mat-select>
            <mat-hint>Assign this user to a specific school</mat-hint>
            <mat-error>{{ getErrorMessage('schoolId') }}</mat-error>
          </mat-form-field>
        </div>

        <!-- Personal Information -->
        <div class="section-label">
          <mat-icon>badge</mat-icon>
          <span>Personal Information</span>
        </div>

        <div class="grid-2">
          <mat-form-field appearance="outline" class="field">
            <mat-label>First Name <span class="req">*</span></mat-label>
            <mat-icon matPrefix class="field-prefix-icon">person</mat-icon>
            <input matInput formControlName="firstName" placeholder="John" autocomplete="given-name" />
            <mat-error>{{ getErrorMessage('firstName') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="field">
            <mat-label>Last Name <span class="req">*</span></mat-label>
            <mat-icon matPrefix class="field-prefix-icon">person</mat-icon>
            <input matInput formControlName="lastName" placeholder="Doe" autocomplete="family-name" />
            <mat-error>{{ getErrorMessage('lastName') }}</mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- ══ CONTACT TAB ══ -->
      <div *ngIf="activeTab === 'contact'" class="tab-pane" role="tabpanel">
        <div class="section-label">
          <mat-icon>contact_phone</mat-icon>
          <span>Contact Details</span>
        </div>

        <div class="grid-1">
          <mat-form-field appearance="outline" class="field">
            <mat-label>Email Address <span class="req">*</span></mat-label>
            <mat-icon matPrefix class="field-prefix-icon">email</mat-icon>
            <input matInput type="email" formControlName="email"
                   placeholder="user@example.com" autocomplete="email" />
            <mat-error>{{ getErrorMessage('email') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="field">
            <mat-label>Phone Number</mat-label>
            <mat-icon matPrefix class="field-prefix-icon">phone</mat-icon>
            <input matInput type="tel" formControlName="phoneNumber"
                   placeholder="+1 (555) 123-4567" autocomplete="tel" />
            <mat-hint>Optional — include country code</mat-hint>
          </mat-form-field>
        </div>
      </div>

      <!-- ══ ACCESS TAB ══ -->
      <div *ngIf="activeTab === 'access'" class="tab-pane" role="tabpanel">

        <!-- Roles -->
        <div class="section-label">
          <mat-icon>admin_panel_settings</mat-icon>
          <span>Role Assignment</span>
        </div>

        <mat-form-field appearance="outline" class="field w-full">
          <mat-label>Roles</mat-label>
          <mat-icon matPrefix class="field-prefix-icon">admin_panel_settings</mat-icon>
          <mat-select formControlName="roleIds" multiple>
            <mat-option *ngFor="let role of availableRoles" [value]="role.id">
              <div class="role-option-inner">
                <span class="role-name">{{ role.name }}</span>
                <span class="role-system-badge" *ngIf="role.isSystemRole">System</span>
              </div>
            </mat-option>
          </mat-select>
          <mat-hint>Optional — leave empty for no roles</mat-hint>
        </mat-form-field>

        <div *ngIf="availableRoles.length === 0 && !isLoadingRoles" class="empty-roles-note">
          <mat-icon class="empty-roles-icon">warning_amber</mat-icon>
          <span>No roles available. Please create roles first.</span>
        </div>

        <!-- Account Status (Edit Mode Only) -->
        <div *ngIf="isEditMode" class="section-label mt-section">
          <mat-icon>lock</mat-icon>
          <span>Account Status</span>
        </div>

        <div *ngIf="isEditMode" class="toggle-cards">
          <div class="toggle-card">
            <div class="toggle-card-text">
              <mat-icon class="toggle-icon green">check_circle</mat-icon>
              <div>
                <p class="toggle-title">Active Account</p>
                <p class="toggle-desc">Inactive users cannot log in to the system</p>
              </div>
            </div>
            <mat-checkbox formControlName="isActive" color="primary"></mat-checkbox>
          </div>
        </div>

        <!-- Options (Create Mode Only) -->
        <div *ngIf="!isEditMode" class="section-label mt-section">
          <mat-icon>settings</mat-icon>
          <span>Options</span>
        </div>

        <div *ngIf="!isEditMode" class="toggle-cards">
          <div class="toggle-card">
            <div class="toggle-card-text">
              <mat-icon class="toggle-icon indigo">mark_email_read</mat-icon>
              <div>
                <p class="toggle-title">Send Welcome Email</p>
                <p class="toggle-desc">Send login instructions to the user's email address</p>
              </div>
            </div>
            <mat-checkbox formControlName="sendWelcomeEmail" color="primary"></mat-checkbox>
          </div>
        </div>
      </div>

    </form>

    <!-- ── Tab Navigation ──────────────────────────────────────────────── -->
    <div class="tab-nav">
      <div class="tab-nav-left">
        <button *ngIf="!isFirstTab"
                type="button"
                mat-stroked-button
                class="nav-btn prev-btn"
                (click)="prevTab()">
          <mat-icon>chevron_left</mat-icon>
          Previous
        </button>
      </div>
      <div class="tab-nav-right">
        <button *ngIf="!isLastTab"
                type="button"
                mat-flat-button
                class="nav-btn next-btn"
                (click)="nextTab()">
          Next
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
    </div>

  </div><!-- /form-panel -->
</div><!-- /dialog-body -->

<!-- ── Footer ─────────────────────────────────────────────────────────────── -->
<div class="dialog-footer">
  <div *ngIf="formSubmitted && form.invalid" class="footer-error">
    <mat-icon class="footer-error-icon">warning_amber</mat-icon>
    <span>Please fill in all required fields before submitting</span>
  </div>

  <div class="footer-actions">
    <button type="button"
            mat-stroked-button
            class="cancel-btn"
            [disabled]="isSaving"
            (click)="onCancel()">
      Cancel
    </button>

    <button type="button"
            mat-flat-button
            class="submit-btn"
            [disabled]="isSaving || isLoadingRoles || isLoadingSchools"
            (click)="onSave()">
      <mat-spinner *ngIf="isSaving" diameter="18" class="btn-spinner"></mat-spinner>
      <mat-icon *ngIf="!isSaving" class="submit-icon">{{ isEditMode ? 'save' : 'check_circle' }}</mat-icon>
      <span>{{ isSaving ? 'Saving…' : (isEditMode ? 'Update' : 'Submit') }}</span>
    </button>
  </div>
</div>