<div class="flex h-full max-h-[90vh] flex-col overflow-hidden rounded-2xl bg-white dark:bg-gray-900">

  <!-- ================= HEADER ================= -->
  <div class="flex items-center justify-between bg-primary px-6 py-4 text-white">
    <div class="flex items-center gap-3">
      <mat-icon class="text-2xl">subscriptions</mat-icon>
      <div>
        <h3 class="text-lg font-semibold">Manage Subscription</h3>
        <p class="text-sm opacity-80">{{ data.school.name }}</p>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <span
        *ngIf="data.school.subscription"
        class="rounded-full px-3 py-1 text-xs font-semibold text-white"
        [ngClass]="getStatusClass()"
      >
        {{ getStatusDisplayName() }}
      </span>

      <button mat-icon-button (click)="close()" type="button">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <!-- ================= BODY ================= -->
  <div class="flex-1 overflow-y-auto p-6">

    <!-- Loading State -->
    <div *ngIf="isLoading && subscriptionPlans.length === 0"
         class="flex flex-col items-center justify-center py-10">
      <mat-spinner diameter="48"></mat-spinner>
      <p class="mt-4 text-sm text-gray-500">Loading subscription optionsâ€¦</p>
    </div>

    <div *ngIf="!isLoading || subscriptionPlans.length > 0" class="space-y-8">

      <!-- ================= CURRENT SUBSCRIPTION ================= -->
      <div *ngIf="data.school.subscription">
        <h4 class="mb-4 flex items-center gap-2 font-semibold">
          <mat-icon class="text-info">info</mat-icon>
          Current Subscription
        </h4>

        <div class="grid gap-4 md:grid-cols-2">

          <!-- Plan Details -->
          <div class="rounded-xl border p-4 dark:border-gray-700">
            <h6 class="mb-3 text-sm font-medium text-gray-500">Plan Details</h6>

            <div class="space-y-2 text-sm">
              <div>
                <span class="text-gray-500">Plan</span>
                <div class="font-semibold">
                  {{ getPlanName(data.school.subscription.plan) }}
                </div>
              </div>

              <div>
                <span class="text-gray-500">Billing Cycle</span>
                <div class="font-semibold">
                  {{ getBillingCycleName(data.school.subscription.billingCycle) }}
                </div>
              </div>

              <div>
                <span class="text-gray-500">Amount</span>
                <div class="text-lg font-bold text-green-600">
                  {{ formatKES(data.school.subscription.amount) }}
                </div>
              </div>
            </div>
          </div>

          <!-- Status & Dates -->
          <div class="rounded-xl border p-4 dark:border-gray-700">
            <h6 class="mb-3 text-sm font-medium text-gray-500">Status & Dates</h6>

            <div class="space-y-2 text-sm">
              <div>
                <span class="text-gray-500">Status</span>
                <div>
                  <span class="rounded-full px-3 py-1 text-xs font-semibold text-white"
                        [ngClass]="getStatusClass()">
                    {{ getStatusDisplayName() }}
                  </span>
                </div>
              </div>

              <div>
                <span class="text-gray-500">Start Date</span>
                <div>{{ data.school.subscription.startDate | date:'mediumDate' }}</div>
              </div>

              <div>
                <span class="text-gray-500">Expiry Date</span>
                <div
                  [class.text-red-600]="data.school.isSubscriptionExpired"
                  [class.text-yellow-600]="data.school.daysRemaining <= 7 && !data.school.isSubscriptionExpired">
                  {{ data.school.subscription.expiryDate | date:'mediumDate' }}
                  <span *ngIf="data.school.daysRemaining > 0 && !data.school.isSubscriptionExpired" class="text-xs text-gray-500">
                    ({{ data.school.daysRemaining }} days left)
                  </span>
                  <span *ngIf="data.school.isSubscriptionExpired" class="ml-1 font-semibold">
                    - EXPIRED
                  </span>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- ================= PLAN SELECTION ================= -->
      <div>
        <h4 class="mb-4 flex items-center gap-2 font-semibold">
          <mat-icon color="primary">
            {{ data.school.subscription ? 'autorenew' : 'add' }}
          </mat-icon>
          {{ data.school.subscription ? 'Renew / Upgrade Subscription' : 'Create New Subscription' }}
        </h4>

        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          <div *ngFor="let plan of subscriptionPlans"
               (click)="selectedPlan = plan.planValue"
               class="relative cursor-pointer rounded-xl border p-4 transition hover:shadow-lg"
               [class.border-primary]="selectedPlan === plan.planValue"
               [class.border-2]="selectedPlan === plan.planValue">

            <span *ngIf="plan.isMostPopular"
                  class="absolute -top-3 left-1/2 -translate-x-1/2 rounded-full bg-green-600 px-3 py-1 text-xs font-semibold text-white">
              Most Popular
            </span>

            <div class="text-center">
              <h5 class="font-bold">{{ plan.name }}</h5>
              <div class="mt-2 text-2xl font-bold text-primary">
                {{ formatKES(getPlanPriceForPlan(plan.planValue)) }}
              </div>
              <p class="text-xs text-gray-500">{{ getCycleSuffix() }}</p>
              <p class="mt-2 text-sm text-gray-500">{{ plan.description }}</p>
            </div>

            <ul class="mt-4 space-y-2 text-sm">
              <!-- Fixed: Removed multiple *ngFor on same element -->
              <ng-container *ngIf="plan.features && plan.features.length > 0">
                <li *ngFor="let feature of plan.features" class="flex gap-2">
                  <mat-icon class="text-green-600" style="font-size: 16px; height: 16px; width: 16px;">check</mat-icon>
                  <span>{{ feature }}</span>
                </li>
              </ng-container>
              <li *ngIf="!plan.features || plan.features.length === 0" class="text-gray-400">
                No features listed
              </li>
            </ul>

            <button mat-flat-button
                    color="primary"
                    class="mt-4 w-full"
                    type="button"
                    [disabled]="selectedPlan === plan.planValue">
              {{ selectedPlan === plan.planValue ? 'Selected' : 'Choose Plan' }}
            </button>
          </div>
        </div>

        <!-- No Plans Available -->
        <div *ngIf="subscriptionPlans.length === 0 && !isLoading"
             class="mt-4 flex items-center gap-2 rounded-lg bg-yellow-100 p-3 text-sm text-yellow-800">
          <mat-icon>warning</mat-icon>
          <span>No subscription plans are currently available.</span>
        </div>
      </div>

      <!-- ================= BILLING OPTIONS ================= -->
      <div class="grid gap-4 md:grid-cols-2">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Billing Cycle</mat-label>
          <mat-select [(ngModel)]="selectedCycle">
            <mat-option *ngFor="let cycle of billingCycles" [value]="cycle.value">
              {{ cycle.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Custom Amount (KES)</mat-label>
          <input matInput type="number" [(ngModel)]="customAmount" min="1">
          <mat-hint>Leave empty to use plan price</mat-hint>
        </mat-form-field>
      </div>

      <!-- Notes -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Notes (Optional)</mat-label>
        <textarea matInput rows="3" [(ngModel)]="notes"></textarea>
      </mat-form-field>

      <!-- ================= ORDER SUMMARY ================= -->
      <div *ngIf="selectedPlan && getSelectedPlan()"
           class="rounded-xl border border-primary p-4">
        <h6 class="mb-3 font-semibold">Order Summary</h6>

        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span>Plan</span>
            <span class="font-medium">{{ getSelectedPlan()?.name }}</span>
          </div>
          <div class="flex justify-between">
            <span>Billing Cycle</span>
            <span class="font-medium">{{ getBillingCycleName(selectedCycle) }}</span>
          </div>
          <div class="flex justify-between border-t pt-2 font-semibold text-green-600">
            <span>Total</span>
            <span>{{ formatKES(getPlanAmount()) }} {{ getCycleDescription() }}</span>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ================= FOOTER ================= -->
  <div class="flex flex-wrap items-center justify-between gap-3 border-t px-6 py-4 dark:border-gray-700">

    <div class="flex gap-2" *ngIf="data.school.subscription">
      <button mat-stroked-button color="warn" (click)="cancelSubscription()" type="button">
        Cancel
      </button>
      <button mat-stroked-button color="accent" (click)="suspendSubscription()" type="button">
        Suspend
      </button>
      <button *ngIf="canActivateSubscription()"
              mat-stroked-button
              color="primary"
              (click)="activateSubscription()"
              type="button">
        Activate
      </button>
    </div>

    <div class="ml-auto flex gap-2">
      <button mat-stroked-button (click)="close()" type="button">
        Close
      </button>
      <button mat-flat-button
              color="primary"
              [disabled]="!selectedPlan || !selectedCycle || isLoading"
              (click)="data.school.subscription ? renewSubscription() : createNewSubscription()"
              type="button">
        <span *ngIf="!isLoading">
          {{ data.school.subscription ? 'Renew Subscription' : 'Create Subscription' }}
        </span>
        <span *ngIf="isLoading" class="flex items-center gap-2">
          <mat-spinner diameter="20"></mat-spinner>
          Processing...
        </span>
      </button>
    </div>
  </div>

</div>