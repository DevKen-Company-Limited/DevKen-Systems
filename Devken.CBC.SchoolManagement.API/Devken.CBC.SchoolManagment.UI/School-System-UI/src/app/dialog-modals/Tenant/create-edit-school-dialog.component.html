<!-- create-edit-school-dialog.component.html -->

<!-- ─── Gradient Header ──────────────────────────────────────────────────── -->
<div class="dialog-header">
  <div class="header-left">
    <div class="header-icon-ring">
      <mat-icon class="header-icon">{{ isEdit ? 'edit_note' : 'domain_add' }}</mat-icon>
    </div>
    <div class="header-text">
      <h2 class="header-title">{{ isEdit ? 'Edit School' : 'Create New School' }}</h2>
      <p class="header-subtitle">
        {{ isEdit ? 'Update school information and settings' : 'Add a new school to the platform' }}
      </p>
    </div>
  </div>
  <button mat-icon-button class="close-btn" (click)="cancel()" matTooltip="Close">
    <mat-icon>close</mat-icon>
  </button>
</div>

<!-- ─── Upload progress bar ──────────────────────────────────────────────── -->
<mat-progress-bar *ngIf="isUploadingLogo" mode="indeterminate" color="primary"></mat-progress-bar>

<!-- ─── Tabbed Form (flex body) ──────────────────────────────────────────── -->
<form [formGroup]="form" class="dialog-form" (ngSubmit)="submit()">
  <mat-tab-group animationDuration="200ms" class="school-dialog-tabs">

    <!-- ══════════════════════════════════════════ TAB 1 · Basic Info ══════ -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">info</mat-icon>
        Basic Info
      </ng-template>

      <div class="tab-pane">

        <!-- ── Logo upload ───────────────────────────────────────────────── -->
        <div class="logo-section">
          <p class="section-label">
            <mat-icon>add_photo_alternate</mat-icon>
            School Logo
          </p>

          <!-- Drop zone -->
          <div
            class="drop-zone"
            [class.dragover]="isDraggingOver"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event)"
            (click)="openFilePicker()">

            <input
              #fileInput
              type="file"
              accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
              style="display:none"
              (change)="onFileSelected($event)">

            <!-- PATH A: local file selected via picker / drop -->
            <div *ngIf="logoLocalPreview" class="logo-preview-wrap">
              <img [src]="logoLocalPreview" alt="Logo preview" class="logo-preview-img">
              <button
                type="button"
                class="logo-remove-btn"
                (click)="$event.stopPropagation(); removeLogo()"
                matTooltip="Remove logo">
                <mat-icon>close</mat-icon>
              </button>
            </div>

            <!-- PATH B: existing server logo -->
            <ng-container *ngIf="!logoLocalPreview && logoServerUrl">
              <ng-container *ngIf="logoServerUrl | secureImage | async as safeSrc; else serverLogoLoading">
                <div class="logo-preview-wrap">
                  <img [src]="safeSrc" alt="School logo" class="logo-preview-img">
                  <button
                    type="button"
                    class="logo-remove-btn"
                    (click)="$event.stopPropagation(); removeLogo()"
                    matTooltip="Remove logo">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              </ng-container>
              <ng-template #serverLogoLoading>
                <div class="logo-loading-wrap">
                  <div class="logo-loading-box">
                    <mat-icon style="font-size:32px;width:32px;height:32px;color:#d1d5db;animation:pulse 1.5s infinite">image</mat-icon>
                  </div>
                  <p class="logo-loading-text">Loading logo…</p>
                </div>
              </ng-template>
            </ng-container>

            <!-- No logo — upload prompt -->
            <ng-container *ngIf="!logoLocalPreview && !logoServerUrl">
              <div class="drop-zone-prompt">
                <div class="drop-zone-icon-wrap">
                  <mat-icon>add_photo_alternate</mat-icon>
                </div>
                <p class="drop-zone-text">
                  Drop logo here or <span class="browse-link">click to browse</span>
                </p>
                <p class="drop-zone-hint">JPG, PNG, GIF, WebP · Max 5 MB</p>
              </div>
            </ng-container>

          </div><!-- /drop-zone -->

          <!-- Logo URL fallback -->
          <mat-form-field appearance="outline" class="field">
            <mat-label>Or paste logo URL</mat-label>
            <input matInput formControlName="logoUrl" placeholder="https://example.com/logo.png" autocomplete="off">
            <mat-icon matPrefix class="field-prefix-icon">link</mat-icon>
            <mat-hint>Optional — ignored when a file is uploaded above</mat-hint>
          </mat-form-field>
        </div>

        <!-- ── Identity ──────────────────────────────────────────────────── -->
        <p class="section-label">
          <mat-icon>school</mat-icon>
          School Identity
        </p>

        <mat-form-field appearance="outline" class="field">
          <mat-label>School Name <span class="req">*</span></mat-label>
          <input matInput formControlName="name" placeholder="e.g. Nairobi Academy" autocomplete="off">
          <mat-icon matPrefix class="field-prefix-icon">school</mat-icon>
          <mat-hint>3–200 characters</mat-hint>
          <mat-error>{{ getError('name') }}</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="field">
          <mat-label>Slug <span class="req">*</span></mat-label>
          <input matInput formControlName="slugName" placeholder="nairobi-academy" autocomplete="off">
          <mat-icon matPrefix class="field-prefix-icon">link</mat-icon>
          <mat-hint>Lowercase letters, numbers, hyphens only</mat-hint>
          <button mat-icon-button matSuffix type="button"
                  (click)="generateSlugFromName()" matTooltip="Auto-generate from name">
            <mat-icon>auto_awesome</mat-icon>
          </button>
          <mat-error>{{ getError('slugName') }}</mat-error>
        </mat-form-field>

        <!-- ── Classification ────────────────────────────────────────────── -->
        <p class="section-label">
          <mat-icon>category</mat-icon>
          Classification
        </p>

        <div class="grid-2">
          <mat-form-field appearance="outline" class="field">
            <mat-label>School Type <span class="req">*</span></mat-label>
            <mat-select formControlName="schoolType">
              <mat-option *ngFor="let t of schoolTypeOptions" [value]="t.value">{{ t.label }}</mat-option>
            </mat-select>
            <mat-icon matPrefix class="field-prefix-icon">category</mat-icon>
            <mat-error>{{ getError('schoolType') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="field">
            <mat-label>School Category <span class="req">*</span></mat-label>
            <mat-select formControlName="category">
              <mat-option *ngFor="let c of categoryOptions" [value]="c.value">{{ c.label }}</mat-option>
            </mat-select>
            <mat-icon matPrefix class="field-prefix-icon">home_work</mat-icon>
            <mat-error>{{ getError('category') }}</mat-error>
          </mat-form-field>
        </div>

        <!-- ── Status toggle ─────────────────────────────────────────────── -->
        <div class="toggle-card">
          <div class="toggle-card-text">
            <mat-icon class="toggle-icon" [class.green]="form.get('isActive')?.value" [class.indigo]="!form.get('isActive')?.value">
              {{ form.get('isActive')?.value ? 'check_circle' : 'cancel' }}
            </mat-icon>
            <div>
              <p class="toggle-title">School Status</p>
              <p class="toggle-desc">
                {{ form.get('isActive')?.value ? 'School is active and accessible' : 'School is disabled' }}
              </p>
            </div>
          </div>
          <mat-slide-toggle formControlName="isActive" color="primary"></mat-slide-toggle>
        </div>

      </div><!-- /tab-pane -->
    </mat-tab>

    <!-- ══════════════════════════════════════════ TAB 2 · Contact & Location -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">location_on</mat-icon>
        Contact & Location
      </ng-template>

      <div class="tab-pane">

        <p class="section-label">
          <mat-icon>contact_phone</mat-icon>
          Contact Details
        </p>

        <div class="grid-2">
          <mat-form-field appearance="outline" class="field">
            <mat-label>Email Address</mat-label>
            <input matInput type="email" formControlName="email" placeholder="school@example.com" autocomplete="off">
            <mat-icon matPrefix class="field-prefix-icon">email</mat-icon>
            <mat-error>{{ getError('email') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="field">
            <mat-label>Phone Number</mat-label>
            <input matInput formControlName="phoneNumber" placeholder="+254 700 000 000" autocomplete="off">
            <mat-icon matPrefix class="field-prefix-icon">phone</mat-icon>
            <mat-error>{{ getError('phoneNumber') }}</mat-error>
          </mat-form-field>
        </div>

        <p class="section-label">
          <mat-icon>map</mat-icon>
          Location
        </p>

        <mat-form-field appearance="outline" class="field">
          <mat-label>Physical Address</mat-label>
          <textarea matInput formControlName="address" placeholder="Street, Building, Area…" rows="2"></textarea>
          <mat-icon matPrefix class="field-prefix-icon">map</mat-icon>
          <mat-error>{{ getError('address') }}</mat-error>
        </mat-form-field>

        <div class="grid-2">
          <mat-form-field appearance="outline" class="field">
            <mat-label>County</mat-label>
            <mat-select formControlName="county">
              <mat-option value="">— Select county —</mat-option>
              <mat-option *ngFor="let c of kenyanCounties" [value]="c">{{ c }}</mat-option>
            </mat-select>
            <mat-icon matPrefix class="field-prefix-icon">location_city</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="field">
            <mat-label>Sub-County</mat-label>
            <input matInput formControlName="subCounty" placeholder="e.g. Westlands" autocomplete="off">
            <mat-icon matPrefix class="field-prefix-icon">near_me</mat-icon>
            <mat-error>{{ getError('subCounty') }}</mat-error>
          </mat-form-field>
        </div>

      </div><!-- /tab-pane -->
    </mat-tab>

    <!-- ══════════════════════════════════════════ TAB 3 · Legal ═══════════ -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">gavel</mat-icon>
        Legal
      </ng-template>

      <div class="tab-pane">

        <p class="section-label">
          <mat-icon>gavel</mat-icon>
          Government Registration
        </p>

        <mat-form-field appearance="outline" class="field">
          <mat-label>Registration Number</mat-label>
          <input matInput formControlName="registrationNumber" placeholder="e.g. REG/2024/001" autocomplete="off">
          <mat-icon matPrefix class="field-prefix-icon">badge</mat-icon>
          <mat-hint>Official government registration number</mat-hint>
          <mat-error>{{ getError('registrationNumber') }}</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="field">
          <mat-label>KNEC Center Code</mat-label>
          <input matInput formControlName="knecCenterCode" placeholder="e.g. 12345" autocomplete="off">
          <mat-icon matPrefix class="field-prefix-icon">confirmation_number</mat-icon>
          <mat-hint>Kenya National Examinations Council code</mat-hint>
          <mat-error>{{ getError('knecCenterCode') }}</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="field">
          <mat-label>KRA PIN</mat-label>
          <input matInput formControlName="kraPin" placeholder="e.g. A001234567X" autocomplete="off">
          <mat-icon matPrefix class="field-prefix-icon">receipt_long</mat-icon>
          <mat-hint>Kenya Revenue Authority PIN</mat-hint>
          <mat-error>{{ getError('kraPin') }}</mat-error>
        </mat-form-field>

        <div class="toggle-card">
          <div class="toggle-card-text">
            <mat-icon class="toggle-icon indigo">info</mat-icon>
            <div>
              <p class="toggle-title">Compliance Only</p>
              <p class="toggle-desc">
                These details are used for compliance reporting only and are not displayed publicly.
              </p>
            </div>
          </div>
        </div>

      </div><!-- /tab-pane -->
    </mat-tab>

  </mat-tab-group>
</form>

<!-- ─── Footer ──────────────────────────────────────────────────────────── -->
<div class="dialog-footer">
  <p class="footer-hint">
    <span class="req">*</span> Required fields
  </p>

  <div class="footer-actions">
    <button mat-stroked-button class="cancel-btn" type="button"
            (click)="cancel()" [disabled]="isSaving || isUploadingLogo">
      Cancel
    </button>

    <button mat-flat-button class="submit-btn" type="button"
            (click)="submit()"
            [disabled]="form.invalid || isSaving || isUploadingLogo">

      <ng-container *ngIf="isSaving && !isUploadingLogo">
        <mat-icon class="submit-icon" style="animation:spin 1s linear infinite">sync</mat-icon>
        <span>Saving…</span>
      </ng-container>

      <ng-container *ngIf="isUploadingLogo">
        <mat-icon class="submit-icon" style="animation:spin 1s linear infinite">cloud_upload</mat-icon>
        <span>Uploading logo…</span>
      </ng-container>

      <ng-container *ngIf="!isSaving && !isUploadingLogo">
        <mat-icon class="submit-icon">{{ isEdit ? 'save' : 'add_circle' }}</mat-icon>
        <span>{{ isEdit ? 'Save Changes' : 'Create School' }}</span>
      </ng-container>

    </button>
  </div>
</div>