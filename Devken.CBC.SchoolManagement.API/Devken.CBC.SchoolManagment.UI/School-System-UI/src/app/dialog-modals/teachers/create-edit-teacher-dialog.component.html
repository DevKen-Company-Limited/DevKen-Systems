<div class="flex flex-col w-full max-h-screen">

  <!-- Dialog Header -->
  <div class="flex items-center justify-between px-6 py-4 bg-gradient-to-r from-indigo-700 via-violet-700 to-purple-700 shrink-0">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
        <mat-icon class="text-white">{{ isEditMode ? 'edit' : 'person_add' }}</mat-icon>
      </div>
      <div>
        <h2 class="text-lg font-bold text-white leading-tight">
          {{ isEditMode ? 'Edit Teacher' : 'Add New Teacher' }}
        </h2>
        <p class="text-white/70 text-xs">{{ isEditMode ? 'Update teacher information' : 'Fill in teacher details below' }}</p>
      </div>
    </div>
    <button mat-icon-button (click)="onCancel()" class="text-white/80 hover:text-white hover:bg-white/10 rounded-xl">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Tab Navigation -->
  <div class="flex border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shrink-0 overflow-x-auto">
    <button
      *ngFor="let tab of tabs; let i = index"
      (click)="activeTab = i"
      class="flex items-center gap-2 px-5 py-3 text-sm font-semibold whitespace-nowrap transition-all border-b-2 -mb-px"
      [class.border-indigo-600]="activeTab === i"
      [class.text-indigo-600]="activeTab === i"
      [class.border-transparent]="activeTab !== i"
      [class.text-gray-500]="activeTab !== i"
      [class.dark:text-gray-400]="activeTab !== i"
      [class.hover:text-gray-700]="activeTab !== i">
      <mat-icon class="icon-size-4">{{ tab.icon }}</mat-icon>
      <span>{{ tab.label }}</span>
      <span *ngIf="tabHasErrors(i)"
        class="w-2 h-2 rounded-full bg-red-500 ml-1"></span>
    </button>
  </div>

  <!-- Scrollable Form Body -->
  <form [formGroup]="form" class="flex flex-col flex-auto overflow-y-auto bg-gray-50 dark:bg-gray-900">

    <!-- ── Tab 0: Personal Info ─────────────────────────────────── -->
    <div *ngIf="activeTab === 0" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">

      <!-- Photo Upload -->
      <div class="md:col-span-2 flex items-center gap-5 p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
        <div class="relative">
          <div class="w-20 h-20 rounded-2xl overflow-hidden bg-gradient-to-br from-indigo-100 to-violet-100 dark:from-indigo-900/30 dark:to-violet-900/30 flex items-center justify-center border-2 border-indigo-200 dark:border-indigo-800">
            <img *ngIf="photoPreview || form.get('photoUrl')?.value"
                 [src]="photoPreview || form.get('photoUrl')?.value"
                 class="w-full h-full object-cover" alt="Teacher photo" />
            <mat-icon *ngIf="!photoPreview && !form.get('photoUrl')?.value"
                      class="text-indigo-400 icon-size-10">person</mat-icon>
          </div>
          <button *ngIf="photoPreview || form.get('photoUrl')?.value"
                  type="button" (click)="removePhoto()"
                  class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 rounded-full flex items-center justify-center shadow-md hover:bg-red-600 transition-colors">
            <mat-icon class="text-white icon-size-3 text-xs leading-none">close</mat-icon>
          </button>
        </div>
        <div class="flex flex-col gap-2">
          <p class="text-sm font-semibold text-gray-700 dark:text-gray-300">Profile Photo</p>
          <p class="text-xs text-gray-500 dark:text-gray-400">JPEG, PNG or WebP · Max 5 MB</p>
          <label class="cursor-pointer">
            <span class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold text-indigo-600 border-2 border-indigo-300 dark:border-indigo-700 rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors">
              <mat-icon class="icon-size-4">upload</mat-icon>
              {{ isEditMode ? 'Change Photo' : 'Upload Photo' }}
            </span>
            <input type="file" class="hidden" accept="image/*" (change)="onPhotoSelected($event)" />
          </label>
        </div>
      </div>

      <!-- First Name -->
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>First Name <span class="text-red-500">*</span></mat-label>
        <mat-icon matPrefix class="icon-size-5 mr-2 text-gray-400">badge</mat-icon>
        <input matInput formControlName="firstName" placeholder="e.g. John" />
        <mat-error *ngIf="form.get('firstName')?.hasError('required')">Required</mat-error>
      </mat-form-field>

      <!-- Middle Name -->
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>Middle Name</mat-label>
        <mat-icon matPrefix class="icon-size-5 mr-2 text-gray-400">badge</mat-icon>
        <input matInput formControlName="middleName" placeholder="Optional" />
      </mat-form-field>

      <!-- Last Name -->
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>Last Name <span class="text-red-500">*</span></mat-label>
        <mat-icon matPrefix class="icon-size-5 mr-2 text-gray-400">badge</mat-icon>
        <input matInput formControlName="lastName" placeholder="e.g. Doe" />
        <mat-error *ngIf="form.get('lastName')?.hasError('required')">Required</mat-error>
      </mat-form-field>

      <!-- Teacher Number -->
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>Teacher Number <span class="text-red-500">*</span></mat-label>
        <mat-icon matPrefix class="icon-size-5 mr-2 text-gray-400">tag</mat-icon>
        <input matInput formControlName="teacherNumber" placeholder="e.g. TCH-001" />
        <mat-error *ngIf="form.get('teacherNumber')?.hasError('required')">Required</mat-error>
      </mat-form-field>

      <!-- Gender -->
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>Gender <span class="text-red-500">*</span></mat-label>
        <mat-icon matPrefix class="icon-size-5 mr-2 text-gray-400">wc</mat-icon>
        <mat-select formControlName="gender">
          <mat-option *ngFor="let g of (genders$ | async)" [value]="g.value">{{ g.name }}</mat-option>
        </mat-select>
        <mat-error *ngIf="form.get('gender')?.hasError('required')">Required</mat-error>
      </mat-form-field>

      <!-- Date of Birth -->
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>Date of Birth</mat-label>
        <mat-icon matPrefix class="icon-size-5 mr-2 text-gray-400">cake</mat-icon>
        <input matInput [matDatepicker]="dobPicker" formControlName="dateOfBirth" />
        <mat-datepicker-toggle matIconSuffix [for]="dobPicker"></mat-datepicker-toggle>
        <mat-datepicker #dobPicker></mat-datepicker>
      </mat-form-field>

      <!-- National ID -->
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>National ID Number</mat-label>
        <mat-icon matPrefix class="icon-size-5 mr-2 text-gray-400">credit_card</mat-icon>
        <input matInput formControlName="idNumber" placeholder="National ID / Passport" />
      </mat-form-field>

      <!-- Nationality -->
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>Nationality</mat-label>
        <mat-icon matPrefix class="icon-size-5 mr-2 text-gray-400">flag</mat-icon>
        <input matInput formControlName="nationality" placeholder="e.g. Kenyan" />
      </mat-form-field>
    </div>

    <!-- ── Tab 1: Contact ───────────────────────────────────────── -->
    <div *ngIf="activeTab === 1" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">

      <!-- Phone -->
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>Phone Number</mat-label>
        <mat-icon matPrefix class="icon-size-5 mr-2 text-gray-400">phone</mat-icon>
        <input matInput formControlName="phoneNumber" placeholder="+254 7XX XXX XXX" />
      </mat-form-field>

      <!-- Email -->
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>Email Address</mat-label>
        <mat-icon matPrefix class="icon-size-5 mr-2 text-gray-400">email</mat-icon>
        <input matInput type="email" formControlName="email" placeholder="teacher@school.ac.ke" />
        <mat-error *ngIf="form.get('email')?.hasError('email')">Enter a valid email</mat-error>
      </mat-form-field>

      <!-- Address -->
      <mat-form-field class="w-full md:col-span-2" appearance="outline">
        <mat-label>Home Address</mat-label>
        <mat-icon matPrefix class="icon-size-5 mr-2 text-gray-400">home</mat-icon>
        <textarea matInput formControlName="address" rows="3" placeholder="Postal address or physical location"></textarea>
      </mat-form-field>
    </div>

    <!-- ── Tab 2: Professional ─────────────────────────────────── -->
    <div *ngIf="activeTab === 2" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">

      <!-- TSC Number -->
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>TSC Number</mat-label>
        <mat-icon matPrefix class="icon-size-5 mr-2 text-gray-400">school</mat-icon>
        <input matInput formControlName="tscNumber" placeholder="Teachers Service Commission No." />
      </mat-form-field>

      <!-- Employment Type -->
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>Employment Type</mat-label>
        <mat-icon matPrefix class="icon-size-5 mr-2 text-gray-400">work</mat-icon>
        <mat-select formControlName="employmentType">
          <mat-option *ngFor="let et of (employmentTypes$ | async)" [value]="et.value">{{ et.name }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Designation -->
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>Designation</mat-label>
        <mat-icon matPrefix class="icon-size-5 mr-2 text-gray-400">military_tech</mat-icon>
        <mat-select formControlName="designation">
          <mat-option *ngFor="let d of (designations$ | async)" [value]="d.value">{{ d.name }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Date of Employment -->
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>Date of Employment</mat-label>
        <mat-icon matPrefix class="icon-size-5 mr-2 text-gray-400">event</mat-icon>
        <input matInput [matDatepicker]="empPicker" formControlName="dateOfEmployment" />
        <mat-datepicker-toggle matIconSuffix [for]="empPicker"></mat-datepicker-toggle>
        <mat-datepicker #empPicker></mat-datepicker>
      </mat-form-field>

      <!-- Qualification -->
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>Qualification</mat-label>
        <mat-icon matPrefix class="icon-size-5 mr-2 text-gray-400">menu_book</mat-icon>
        <input matInput formControlName="qualification" placeholder="e.g. B.Ed, PGDE" />
      </mat-form-field>

      <!-- Specialization -->
      <mat-form-field class="w-full" appearance="outline">
        <mat-label>Specialization</mat-label>
        <mat-icon matPrefix class="icon-size-5 mr-2 text-gray-400">science</mat-icon>
        <input matInput formControlName="specialization" placeholder="e.g. Mathematics, Science" />
      </mat-form-field>

      <!-- Is Class Teacher -->
      <div class="md:col-span-2 flex items-center gap-3 p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
        <mat-slide-toggle formControlName="isClassTeacher" color="primary"></mat-slide-toggle>
        <div>
          <p class="text-sm font-semibold text-gray-700 dark:text-gray-300">Class Teacher</p>
          <p class="text-xs text-gray-500 dark:text-gray-400">This teacher is assigned as a class teacher</p>
        </div>
      </div>

      <!-- Is Active -->
      <div class="md:col-span-2 flex items-center gap-3 p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
        <mat-slide-toggle formControlName="isActive" color="primary"></mat-slide-toggle>
        <div>
          <p class="text-sm font-semibold text-gray-700 dark:text-gray-300">Active Status</p>
          <p class="text-xs text-gray-500 dark:text-gray-400">Toggle to activate or deactivate this teacher</p>
        </div>
      </div>

      <!-- Notes -->
      <mat-form-field class="w-full md:col-span-2" appearance="outline">
        <mat-label>Notes</mat-label>
        <mat-icon matPrefix class="icon-size-5 mr-2 text-gray-400">notes</mat-icon>
        <textarea matInput formControlName="notes" rows="3" placeholder="Any additional notes..."></textarea>
      </mat-form-field>
    </div>

  </form>

  <!-- Dialog Footer -->
  <div class="flex items-center justify-between px-6 py-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shrink-0">
    <p *ngIf="form.invalid && formSubmitted" class="text-sm text-red-500 flex items-center gap-1">
      <mat-icon class="icon-size-4">error_outline</mat-icon>
      Please fix all errors before saving.
    </p>
    <div class="flex items-center gap-3 ml-auto">
      <button mat-stroked-button (click)="onCancel()" [disabled]="isSaving">Cancel</button>
      <button mat-flat-button color="primary" (click)="onSubmit()" [disabled]="isSaving"
        class="bg-gradient-to-r from-indigo-600 to-violet-600 text-white min-w-28">
        <mat-spinner *ngIf="isSaving" diameter="18" class="mr-2"></mat-spinner>
        <mat-icon *ngIf="!isSaving" class="icon-size-5 mr-1">{{ isEditMode ? 'save' : 'add' }}</mat-icon>
        {{ isSaving ? 'Saving...' : (isEditMode ? 'Save Changes' : 'Create Teacher') }}
      </button>
    </div>
  </div>

</div>