<div class="flex flex-col flex-auto min-w-0">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row flex-0 sm:items-center sm:justify-between p-6 sm:py-8 sm:px-10 border-b bg-card dark:bg-gray-900 shadow-sm">
    <div class="flex-1 min-w-0">
      <!-- Breadcrumbs -->
      <div class="flex flex-wrap items-center text-sm font-medium text-gray-500 dark:text-gray-400">
        <a class="hover:text-primary-500 transition-colors">Administration</a>
        <mat-icon class="icon-size-5 mx-1" [svgIcon]="'heroicons_solid:chevron-right'"></mat-icon>
        <a class="hover:text-primary-500 transition-colors">Role Management</a>
        <mat-icon class="icon-size-5 mx-1" [svgIcon]="'heroicons_solid:chevron-right'"></mat-icon>
        <span class="text-gray-400">Role Assignment</span>
      </div>

      <!-- Title -->
      <h2 class="mt-2 text-3xl md:text-4xl font-extrabold tracking-tight truncate text-gray-900 dark:text-white">
        Role Assignment Manager
      </h2>
    </div>

    <!-- Actions -->
    <div class="flex shrink-0 items-center mt-6 sm:mt-0 sm:ml-4 gap-3">
      <!-- Stats -->
      <div class="hidden sm:flex items-center gap-4 mr-4">
        <div class="text-center">
          <div class="text-2xl font-bold text-primary">{{ stats.totalRoles }}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">Total Roles</div>
        </div>
        <div class="h-10 w-px bg-gray-300 dark:bg-gray-600"></div>
        <div class="text-center">
          <div class="text-2xl font-bold text-primary">{{ stats.totalUsers }}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">Total Users</div>
        </div>
      </div>

      <button mat-flat-button color="primary" (click)="loadData()" class="flex items-center gap-2">
        <mat-icon [svgIcon]="'heroicons_outline:arrow-path'"></mat-icon>
        Refresh
      </button>
    </div>
  </div>

  <!-- Alert -->
  <fuse-alert
    class="m-6"
    *ngIf="showAlert"
    [appearance]="'outline'"
    [showIcon]="true"
    [type]="alert.type"
    [dismissible]="true"
    (dismissed)="showAlert = false">
    {{ alert.message }}
  </fuse-alert>

  <!-- Tabs -->
  <mat-tab-group
    [(selectedIndex)]="selectedTabIndex"
    class="flex-auto p-6 sm:p-10"
    [animationDuration]="'200ms'">

    <!-- Tab 1: User Management -->
    <mat-tab label="User Management">
      <ng-template mat-tab-label>
        <mat-icon class="mr-2" [svgIcon]="'heroicons_outline:users'"></mat-icon>
        All Users
      </ng-template>

      <div class="mt-6">
        <mat-card class="shadow-md hover:shadow-lg transition-shadow">
          <mat-card-header class="pb-4">
            <mat-card-title class="text-2xl font-semibold">Manage User Roles</mat-card-title>
          </mat-card-header>

          <mat-card-content>
            <!-- Search and Filter -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
              <mat-form-field class="flex-auto">
                <mat-label>Search users</mat-label>
                <input
                  matInput
                  [(ngModel)]="userSearchTerm"
                  (ngModelChange)="searchSubject.next($event)"
                  placeholder="Name, email, or username"
                  autocomplete="off">
                <mat-icon matPrefix [svgIcon]="'heroicons_outline:magnifying-glass'"></mat-icon>
                <button *ngIf="userSearchTerm" mat-icon-button matSuffix (click)="clearUserFilter()">
                  <mat-icon [svgIcon]="'heroicons_outline:x-mark'"></mat-icon>
                </button>
              </mat-form-field>

              <mat-form-field class="md:w-64">
                <mat-label>Filter by role</mat-label>
                <mat-select [(value)]="roleFilterValue" (selectionChange)="applyUserFilter()">
                  <mat-option [value]="null">All Users</mat-option>
                  <mat-option *ngFor="let role of availableRoles" [value]="role.roleId">
                    {{ role.roleName }}
                  </mat-option>
                </mat-select>
                <mat-icon matPrefix [svgIcon]="'heroicons_outline:funnel'"></mat-icon>
              </mat-form-field>
            </div>

            <!-- Loading Spinner -->
            <div *ngIf="isLoading" class="flex items-center justify-center h-64">
              <mat-spinner [diameter]="48"></mat-spinner>
            </div>

            <!-- Users Table -->
            <div *ngIf="!isLoading" class="overflow-x-auto rounded-md border border-gray-200 dark:border-gray-700">
              <table mat-table [dataSource]="usersDataSource" matSort class="w-full text-left">
                <!-- User Column -->
                <ng-container matColumnDef="user">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold px-4 py-3 bg-gray-50 dark:bg-gray-800">User</th>
                  <td mat-cell *matCellDef="let user" class="px-4 py-3">
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center shadow-sm text-white font-semibold text-sm">
                        {{ getUserInitials(user.fullName) }}
                      </div>
                      <div class="truncate">
                        <div class="font-medium text-gray-900 dark:text-white">{{ user.fullName }}</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">{{ user.userName }}</div>
                      </div>
                    </div>
                  </td>
                </ng-container>

                <!-- Email Column -->
                <ng-container matColumnDef="email">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold px-4 py-3 bg-gray-50 dark:bg-gray-800">Email</th>
                  <td mat-cell *matCellDef="let user" class="px-4 py-3 flex items-center gap-2">
                    <mat-icon class="icon-size-4 text-gray-400" [svgIcon]="'heroicons_outline:envelope'"></mat-icon>
                    {{ user.email }}
                  </td>
                </ng-container>

                <!-- Roles Column -->
                <ng-container matColumnDef="roles">
                  <th mat-header-cell *matHeaderCellDef class="font-semibold px-4 py-3 bg-gray-50 dark:bg-gray-800">Assigned Roles</th>
                  <td mat-cell *matCellDef="let user" class="px-4 py-3">
                    <div class="flex flex-wrap gap-2">
                      <ng-container *ngIf="user.roles.length > 0">
                        <span *ngFor="let role of user.roles.slice(0,3)" class="inline-flex items-center px-2.5 py-0.5 text-xs font-medium rounded-full bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-200">
                          <mat-icon class="icon-size-3 mr-1" [svgIcon]="'heroicons_outline:shield-check'"></mat-icon>
                          {{ role.roleName }}
                        </span>
                        <span *ngIf="user.roles.length > 3" class="inline-flex items-center px-2.5 py-0.5 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                          +{{ user.roles.length - 3 }} more
                        </span>
                      </ng-container>
                      <span *ngIf="user.roles.length === 0" class="text-sm text-gray-400 italic">No roles assigned</span>
                    </div>
                  </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef class="font-semibold px-4 py-3 text-right bg-gray-50 dark:bg-gray-800">Actions</th>
                  <td mat-cell *matCellDef="let user" class="px-4 py-3 text-right">
                    <button mat-icon-button [matMenuTriggerFor]="userMenu" matTooltip="More actions">
                      <mat-icon [svgIcon]="'heroicons_outline:ellipsis-vertical'"></mat-icon>
                    </button>
                    <mat-menu #userMenu="matMenu">
                      <button mat-menu-item (click)="openManageRolesDialog(user)">
                        <mat-icon [svgIcon]="'heroicons_outline:cog-6-tooth'"></mat-icon>
                        Manage Roles
                      </button>
                      <button mat-menu-item (click)="viewUserDetails(user)">
                        <mat-icon [svgIcon]="'heroicons_outline:eye'"></mat-icon>
                        View Details
                      </button>
                      <mat-divider *ngIf="user.roles.length > 0"></mat-divider>
                      <button *ngIf="user.roles.length > 0" mat-menu-item (click)="removeAllRoles(user.userId)" class="text-warn">
                        <mat-icon [svgIcon]="'heroicons_outline:trash'"></mat-icon>
                        Remove All Roles
                      </button>
                    </mat-menu>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns" class="bg-gray-50 dark:bg-gray-800"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer"></tr>
              </table>

              <!-- Empty State -->
              <div *ngIf="usersDataSource.data.length === 0" class="text-center py-16">
                <mat-icon class="icon-size-16 mb-4 text-gray-400" [svgIcon]="'heroicons_outline:user-group'"></mat-icon>
                <h3 class="text-xl font-semibold mb-2 text-gray-900 dark:text-white">No Users Found</h3>
                <p class="text-gray-500 dark:text-gray-400">
                  {{ userSearchTerm || roleFilterValue ? 'Try adjusting your filters' : 'No users available' }}
                </p>
              </div>

              <!-- Paginator -->
              <mat-paginator *ngIf="usersDataSource.data.length > 0" [length]="totalUsers" [pageSize]="pageSize" [pageSizeOptions]="[10,20,50,100]" (page)="onPageChange($event)" class="border-t mt-4"></mat-paginator>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>

    <!-- Tab 2: Roles Overview -->
    <mat-tab label="Role Overview">
      <ng-template mat-tab-label>
        <mat-icon class="mr-2" [svgIcon]="'heroicons_outline:shield-check'"></mat-icon>
        Roles Overview
      </ng-template>

      <div class="mt-6">
        <!-- Loading Spinner -->
        <div *ngIf="isLoading" class="flex items-center justify-center h-64">
          <mat-spinner [diameter]="48"></mat-spinner>
        </div>

        <!-- Roles Grid -->
        <div *ngIf="!isLoading && availableRoles.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <mat-card *ngFor="let role of availableRoles" class="shadow-md hover:shadow-lg transition-shadow cursor-pointer" (click)="viewRoleUsers(role)">
            <mat-card-header class="pb-4 flex items-center gap-4">
              <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-primary-400 to-primary-600 flex items-center justify-center shadow-sm">
                <mat-icon class="text-white icon-size-6" [svgIcon]="'heroicons_outline:shield-check'"></mat-icon>
              </div>
              <mat-card-title class="text-xl font-bold">{{ role.roleName }}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <p *ngIf="role.description" class="text-gray-500 mb-4">{{ role.description }}</p>
              <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex items-center gap-4">
                  <div class="text-center">
                    <div class="text-2xl font-bold text-primary">{{ role.userCount || 0 }}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Users</div>
                  </div>
                  <div class="h-8 w-px bg-gray-300 dark:bg-gray-600"></div>
                  <div class="text-center">
                    <div class="text-2xl font-bold text-primary">{{ role.permissionCount }}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Permissions</div>
                  </div>
                </div>
                <button mat-icon-button color="primary" (click)="$event.stopPropagation(); viewRoleUsers(role)" matTooltip="View users">
                  <mat-icon [svgIcon]="'heroicons_outline:arrow-right'"></mat-icon>
                </button>
              </div>

              <div class="mt-3 flex flex-wrap gap-2">
                <span *ngIf="role.isSystemRole" class="inline-flex items-center px-2 py-1 text-xs rounded-full bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300">
                  System Role
                </span>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Empty State -->
        <div *ngIf="!isLoading && availableRoles.length === 0" class="text-center py-16">
          <mat-icon class="icon-size-16 mb-4 text-gray-400" [svgIcon]="'heroicons_outline:shield-exclamation'"></mat-icon>
          <h3 class="text-xl font-semibold mb-2 text-gray-900 dark:text-white">No Roles Available</h3>
          <p class="text-gray-500 dark:text-gray-400">Contact your administrator to create roles</p>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
