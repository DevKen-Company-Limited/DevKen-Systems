<!-- summative-assessment-grade.component.html -->
<div class="absolute inset-0 flex min-w-0 flex-col overflow-y-auto">

  <!-- Header -->
  <div class="bg-gradient-to-br from-violet-600 via-purple-600 to-indigo-700 px-6 py-10 sm:px-10">
    <div class="max-w-7xl mx-auto">
      <button mat-button class="text-white/80 hover:text-white mb-4 -ml-2" (click)="goBack()">
        <mat-icon svgIcon="heroicons_outline:arrow-left"></mat-icon>
        <span class="ml-2">Back to Assessments</span>
      </button>

      <div *ngIf="isLoading" class="flex items-center gap-3">
        <mat-progress-spinner mode="indeterminate" diameter="32" class="text-white"></mat-progress-spinner>
        <span class="text-white text-lg">Loading assessment…</span>
      </div>

      <div *ngIf="!isLoading && assessment">
        <div class="flex flex-wrap items-start justify-between gap-4">
          <div>
            <div class="flex items-center gap-2 mb-2">
              <span class="px-3 py-1 rounded-full text-xs font-bold bg-white/20 text-white">
                {{ assessment.examType || 'Exam' }}
              </span>
              <span *ngIf="assessment.hasPracticalComponent"
                class="px-3 py-1 rounded-full text-xs font-bold bg-teal-400/30 text-teal-100">
                + Practical
              </span>
            </div>
            <h1 class="text-2xl sm:text-3xl font-bold text-white">{{ assessment.title }}</h1>
            <p class="text-white/70 mt-1">
              {{ assessment.className }} · {{ assessment.subjectName }} · {{ assessment.termName }}
            </p>
          </div>

          <!-- Quick stats -->
          <div class="flex flex-wrap gap-3">
            <div class="bg-white/10 rounded-xl px-4 py-3 text-center min-w-[80px]">
              <p class="text-2xl font-bold text-white">{{ assessment.maximumScore }}</p>
              <p class="text-xs text-white/70">Max Score</p>
            </div>
            <div class="bg-white/10 rounded-xl px-4 py-3 text-center min-w-[80px]">
              <p class="text-2xl font-bold text-white">{{ assessment.passMark }}%</p>
              <p class="text-xs text-white/70">Pass Mark</p>
            </div>
            <div class="bg-white/10 rounded-xl px-4 py-3 text-center min-w-[80px]">
              <p class="text-2xl font-bold text-white">{{ savedCount }}</p>
              <p class="text-xs text-white/70">Graded</p>
            </div>
            <div class="bg-white/10 rounded-xl px-4 py-3 text-center min-w-[80px]">
              <p class="text-2xl font-bold text-white">{{ rows.length }}</p>
              <p class="text-xs text-white/70">Students</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="bg-card -mt-6 flex-auto rounded-t-2xl shadow">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-10 py-6">

      <!-- Action bar -->
      <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
        <div class="flex items-center gap-2">
          <span *ngIf="dirtyCount > 0"
            class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold
                   bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 border border-amber-200">
            <mat-icon class="icon-size-3.5">edit</mat-icon>
            {{ dirtyCount }} unsaved change{{ dirtyCount !== 1 ? 's' : '' }}
          </span>
        </div>

        <div class="flex flex-wrap gap-2">
          <!-- Recalculate positions -->
          <button mat-stroked-button
            (click)="recalculatePositions()"
            [disabled]="isRecalculating || isSavingAll"
            class="border-violet-200 text-violet-700 hover:bg-violet-50">
            <mat-progress-spinner *ngIf="isRecalculating" mode="indeterminate" diameter="16" class="inline-block mr-1"></mat-progress-spinner>
            <mat-icon *ngIf="!isRecalculating" class="icon-size-4">leaderboard</mat-icon>
            <span class="ml-1">{{ isRecalculating ? 'Recalculating…' : 'Recalc Positions' }}</span>
          </button>

          <!-- Download report -->
          <button mat-stroked-button
            (click)="downloadReport()"
            [disabled]="isDownloading"
            class="border-emerald-200 text-emerald-700 hover:bg-emerald-50">
            <mat-progress-spinner *ngIf="isDownloading" mode="indeterminate" diameter="16" class="inline-block mr-1"></mat-progress-spinner>
            <mat-icon *ngIf="!isDownloading" class="icon-size-4">download</mat-icon>
            <span class="ml-1">{{ isDownloading ? 'Generating…' : 'Score Sheet PDF' }}</span>
          </button>

          <!-- Save all -->
          <button mat-flat-button color="primary"
            (click)="saveAll()"
            [disabled]="isSavingAll || dirtyCount === 0">
            <mat-progress-spinner *ngIf="isSavingAll" mode="indeterminate" diameter="16" class="inline-block mr-1"></mat-progress-spinner>
            <mat-icon *ngIf="!isSavingAll" class="icon-size-4">save</mat-icon>
            <span class="ml-1">{{ isSavingAll ? 'Saving…' : 'Save All (' + dirtyCount + ')' }}</span>
          </button>
        </div>
      </div>

      <!-- Loading state -->
      <div *ngIf="isLoading" class="flex items-center justify-center py-24">
        <mat-progress-spinner mode="indeterminate" diameter="48"></mat-progress-spinner>
      </div>

      <!-- Empty state -->
      <div *ngIf="!isLoading && rows.length === 0"
        class="flex flex-col items-center justify-center py-24 text-center">
        <mat-icon class="icon-size-16 text-gray-300 mb-4">group_off</mat-icon>
        <p class="text-lg font-semibold text-gray-500">No students found</p>
        <p class="text-sm text-gray-400 mt-1">Ensure a class is assigned to this assessment and students are enrolled.</p>
      </div>

      <!-- Grading table -->
      <div *ngIf="!isLoading && rows.length > 0"
        class="overflow-x-auto rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm">
        <table class="w-full text-sm">
          <thead>
            <tr class="bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
              <th class="text-left px-4 py-3 font-semibold text-gray-600 dark:text-gray-400 min-w-[180px]">#  Student</th>
              <th class="text-center px-4 py-3 font-semibold text-gray-600 dark:text-gray-400">
                Theory <span class="text-violet-500">({{ maxTheory }})</span>
              </th>
              <th *ngIf="hasPractical" class="text-center px-4 py-3 font-semibold text-gray-600 dark:text-gray-400">
                Practical <span class="text-teal-500">({{ maxPractical }})</span>
              </th>
              <th class="text-center px-4 py-3 font-semibold text-gray-600 dark:text-gray-400">Total</th>
              <th class="text-center px-4 py-3 font-semibold text-gray-600 dark:text-gray-400">%</th>
              <th class="text-center px-4 py-3 font-semibold text-gray-600 dark:text-gray-400">Status</th>
              <th class="text-left px-4 py-3 font-semibold text-gray-600 dark:text-gray-400">Grade</th>
              <th class="text-left px-4 py-3 font-semibold text-gray-600 dark:text-gray-400">Remarks</th>
              <th class="text-center px-4 py-3 font-semibold text-gray-600 dark:text-gray-400 min-w-[100px]">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100 dark:divide-gray-800">
            <tr *ngFor="let row of rows; let i = index"
              class="transition-colors hover:bg-gray-50 dark:hover:bg-gray-800/50"
              [class.bg-amber-50]="row.isDirty && !row.isSaving"
              [class.dark:bg-amber-90]="row.isDirty && !row.isSaving">

              <!-- Student name -->
              <td class="px-4 py-3">
                <div class="flex items-center gap-2">
                  <div class="w-7 h-7 rounded-full bg-violet-100 dark:bg-violet-900/30
                              flex items-center justify-center flex-shrink-0 text-xs font-bold text-violet-600">
                    {{ i + 1 }}
                  </div>
                  <div>
                    <p class="font-medium text-gray-900 dark:text-white text-sm">{{ row.studentName }}</p>
                    <p *ngIf="row.error" class="text-red-500 text-xs">{{ row.error }}</p>
                  </div>
                </div>
              </td>

              <!-- Theory score -->
              <td class="px-4 py-2 text-center">
                <input type="number"
                  [(ngModel)]="row.theoryScore"
                  (ngModelChange)="onRowChange(row)"
                  [min]="0" [max]="maxTheory"
                  placeholder="—"
                  class="w-20 text-center px-2 py-1.5 rounded-lg border text-sm
                         border-gray-300 dark:border-gray-600
                         bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                         focus:ring-2 focus:ring-violet-500 outline-none transition" />
              </td>

              <!-- Practical score -->
              <td *ngIf="hasPractical" class="px-4 py-2 text-center">
                <input type="number"
                  [(ngModel)]="row.practicalScore"
                  (ngModelChange)="onRowChange(row)"
                  [min]="0" [max]="maxPractical"
                  placeholder="—"
                  class="w-20 text-center px-2 py-1.5 rounded-lg border text-sm
                         border-gray-300 dark:border-gray-600
                         bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                         focus:ring-2 focus:ring-teal-500 outline-none transition" />
              </td>

              <!-- Total -->
              <td class="px-4 py-3 text-center">
                <span class="font-semibold text-gray-900 dark:text-white">
                  {{ row.theoryScore !== null ? calcTotal(row) : '—' }}
                </span>
              </td>

              <!-- Percentage -->
              <td class="px-4 py-3 text-center">
                <span *ngIf="row.theoryScore !== null"
                  class="font-bold text-sm"
                  [class.text-green-600]="calcPercent(row) >= (assessment?.passMark ?? 50)"
                  [class.text-red-600]="calcPercent(row) < (assessment?.passMark ?? 50)">
                  {{ calcPercent(row) }}%
                </span>
                <span *ngIf="row.theoryScore === null" class="text-gray-400">—</span>
              </td>

              <!-- Performance status -->
              <td class="px-4 py-3 text-center">
                <ng-container *ngIf="row.theoryScore !== null">
                  <span class="px-2 py-1 rounded-lg text-xs font-semibold"
                    [ngClass]="{
                      'bg-green-100 text-green-700  dark:bg-green-900/30 dark:text-green-400':  calcPercent(row) >= 80,
                      'bg-teal-100  text-teal-700   dark:bg-teal-900/30  dark:text-teal-400':   calcPercent(row) >= 70 && calcPercent(row) < 80,
                      'bg-blue-100  text-blue-700   dark:bg-blue-900/30  dark:text-blue-400':   calcPercent(row) >= 60 && calcPercent(row) < 70,
                      'bg-amber-100 text-amber-700  dark:bg-amber-900/30 dark:text-amber-400':  calcPercent(row) >= 50 && calcPercent(row) < 60,
                      'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400': calcPercent(row) >= 40 && calcPercent(row) < 50,
                      'bg-red-100   text-red-700    dark:bg-red-900/30   dark:text-red-400':    calcPercent(row) < 40
                    }">
                    {{ performanceStatus(calcPercent(row)) }}
                  </span>
                </ng-container>
                <span *ngIf="row.theoryScore === null" class="text-gray-300">—</span>
              </td>

              <!-- Grade -->
              <td class="px-4 py-2">
                <input type="text"
                  [(ngModel)]="row.grade"
                  (ngModelChange)="onRowChange(row)"
                  placeholder="A, B+…"
                  maxlength="10"
                  class="w-16 px-2 py-1.5 rounded-lg border text-sm
                         border-gray-300 dark:border-gray-600
                         bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                         focus:ring-2 focus:ring-violet-500 outline-none transition" />
              </td>

              <!-- Remarks -->
              <td class="px-4 py-2">
                <input type="text"
                  [(ngModel)]="row.remarks"
                  (ngModelChange)="onRowChange(row)"
                  placeholder="Distinction…"
                  maxlength="20"
                  class="w-28 px-2 py-1.5 rounded-lg border text-sm
                         border-gray-300 dark:border-gray-600
                         bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                         focus:ring-2 focus:ring-violet-500 outline-none transition" />
              </td>

              <!-- Actions -->
              <td class="px-4 py-2 text-center">
                <div class="flex items-center justify-center gap-1">
                  <!-- Save row -->
                  <button mat-icon-button
                    [disabled]="!row.isDirty || row.isSaving"
                    (click)="saveRow(row)"
                    [matTooltip]="'Save ' + row.studentName"
                    class="!w-8 !h-8"
                    [class.text-violet-600]="row.isDirty && !row.isSaving">
                    <mat-progress-spinner *ngIf="row.isSaving" mode="indeterminate" diameter="16"></mat-progress-spinner>
                    <mat-icon *ngIf="!row.isSaving" class="icon-size-4">save</mat-icon>
                  </button>

                  <!-- Delete score -->
                  <button mat-icon-button
                    *ngIf="!row.isNew"
                    (click)="deleteScore(row)"
                    [matTooltip]="'Delete score'"
                    class="!w-8 !h-8 text-red-400 hover:text-red-600">
                    <mat-icon class="icon-size-4">delete</mat-icon>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Bottom save -->
      <div *ngIf="rows.length > 0" class="flex justify-end mt-6">
        <button mat-flat-button color="primary" (click)="saveAll()"
          [disabled]="isSavingAll || dirtyCount === 0"
          class="px-8">
          <mat-icon class="icon-size-4">save</mat-icon>
          <span class="ml-2">{{ isSavingAll ? 'Saving…' : 'Save All Changes' }}</span>
        </button>
      </div>

    </div>
  </div>
</div>