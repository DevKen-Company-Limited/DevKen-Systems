<!-- schools-management.component.html -->

<div class="absolute inset-0 flex min-w-0 flex-col overflow-y-auto" cdkScrollable>

  <!-- ── Page Header ──────────────────────────────────────────────────────── -->
  <app-page-header
    title="School Management"
    description="Create, manage, and monitor all schools on the platform"
    icon="school"
    [breadcrumbs]="breadcrumbs"
    [actionTemplate]="headerActions">
  </app-page-header>

  <!-- Header action button -->
  <ng-template #headerActions>
    <button
      mat-flat-button
      class="bg-white text-indigo-700 hover:bg-yellow-200 hover:text-indigo-900 shadow-lg transition-all hover:shadow-xl font-bold"
      (click)="openCreate()">
      <mat-icon class="icon-size-5">add</mat-icon>
      <span class="ml-2">New School</span>
    </button>
  </ng-template>

  <!-- ── Main Content ──────────────────────────────────────────────────────── -->
  <div class="bg-card -mt-10 flex-auto rounded-t-2xl p-6 shadow sm:p-10">

    <!-- Stats Cards -->
    <app-stats-cards [cards]="statsCards" [columns]="4"></app-stats-cards>

    <!-- Filter Panel -->
    <div class="mb-6">
      <app-filter-panel
        [fields]="filterFields"
        [showPanel]="showFilterPanel"
        [columns]="3"
        (filterChange)="onFilterChange($event)"
        (clearAll)="onClearFilters()"
        (togglePanel)="toggleFilterPanel()">
      </app-filter-panel>
    </div>

    <!-- Data Table -->
    <app-data-table
      [columns]="tableColumns"
      [data]="paginatedData"
      [actions]="tableActions"
      [loading]="isLoading"
      [header]="tableHeader"
      [emptyState]="tableEmptyState"
      [cellTemplates]="cellTemplates">
    </app-data-table>

    <!-- Pagination -->
    <app-pagination
      *ngIf="!isLoading"
      [currentPage]="currentPage"
      [totalItems]="filteredData.length"
      [itemsPerPage]="itemsPerPage"
      [itemLabel]="'schools'"
      [showItemsPerPageSelector]="true"
      [showPageNumbers]="true"
      (pageChange)="onPageChange($event)"
      (itemsPerPageChange)="onItemsPerPageChange($event)">
    </app-pagination>

  </div>
</div>


<!-- ══════════════════════════════════════════════════════════════════════════ -->
<!-- Cell Templates                                                            -->
<!-- ══════════════════════════════════════════════════════════════════════════ -->

<!-- ── School Cell ──────────────────────────────────────────────────────────── -->
<ng-template #schoolCell let-row>
  <div class="flex items-center gap-3 cursor-pointer group" (click)="openView(row)">

    <!-- Avatar container -->
    <div class="w-10 h-10 rounded-xl overflow-hidden shrink-0
                bg-gradient-to-br from-indigo-100 to-violet-100
                flex items-center justify-center
                border border-indigo-200 dark:border-indigo-800">

      <!-- Loading spinner -->
      <div *ngIf="logoCache[row.id]?.isLoading"
           class="w-full h-full flex items-center justify-center">
        <mat-spinner [diameter]="20"></mat-spinner>
      </div>

      <!-- Error state -->
      <div *ngIf="logoCache[row.id]?.error && !logoCache[row.id]?.isLoading"
           class="w-full h-full flex items-center justify-center bg-gray-100 dark:bg-gray-800">
        <mat-icon class="text-gray-400 icon-size-5">broken_image</mat-icon>
      </div>

      <!-- Loaded logo -->
      <img *ngIf="logoCache[row.id]?.url && !logoCache[row.id]?.isLoading"
           [src]="logoCache[row.id].url"
           [alt]="row.name + ' logo'"
           class="w-full h-full object-contain p-0.5" />

      <!-- Initials fallback: shown when no logo URL at all, or while not yet attempted -->
      <span *ngIf="!row.logoUrl && !logoCache[row.id]?.isLoading && !logoCache[row.id]?.error"
            class="text-sm font-bold"
            [ngClass]="row.isActive
              ? 'text-indigo-600 dark:text-indigo-400'
              : 'text-gray-500 dark:text-gray-400'">
        {{ getInitials(row.name) }}
      </span>

      <!-- Initials fallback: shown when logo URL exists but hasn't started loading yet -->
      <span *ngIf="row.logoUrl && !logoCache[row.id]"
            class="text-sm font-bold text-indigo-600 dark:text-indigo-400">
        {{ getInitials(row.name) }}
      </span>
    </div>

    <!-- Name / sub-label -->
    <div class="min-w-0">
      <p class="text-sm font-semibold text-gray-900 dark:text-white truncate
                group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">
        {{ row.name }}
      </p>
      <p class="text-xs text-gray-500 dark:text-gray-400 truncate">
        {{ row.email || row.slugName || '—' }}
      </p>
    </div>
  </div>
</ng-template>


<!-- ── Type Cell ────────────────────────────────────────────────────────────── -->
<ng-template #typeCell let-row>
  <div class="flex flex-col gap-0.5">
    <span class="text-sm font-medium text-gray-800 dark:text-gray-200">
      {{ getSchoolTypeLabel(row.schoolType) }}
    </span>
    <span class="text-xs text-gray-500 dark:text-gray-400">
      {{ getCategoryLabel(row.category) }}
    </span>
  </div>
</ng-template>


<!-- ── Status Cell ──────────────────────────────────────────────────────────── -->
<ng-template #statusCell let-row>
  <span class="px-3 py-1 rounded-full text-xs font-semibold"
        [ngClass]="{
          'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400':  row.isActive,
          'bg-red-100   dark:bg-red-900/30   text-red-700   dark:text-red-400':   !row.isActive
        }">
    {{ row.isActive ? 'Active' : 'Inactive' }}
  </span>
</ng-template>


<!-- ── Created Cell ──────────────────────────────────────────────────────────── -->
<ng-template #createdCell let-row>
  <div class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
    <mat-icon class="icon-size-4 text-gray-400">calendar_today</mat-icon>
    <span>{{ formatDate(row.createdOn) }}</span>
  </div>
</ng-template>